# .guardkit/features/FEAT-SEC.yaml
# Coach Agent Security Integration Feature
# REVISED ARCHITECTURE (from TASK-REV-4B0F): Security runs in pre-loop and task-work, NOT Coach

id: FEAT-SEC
name: "Coach Agent Security Integration"
description: "Add two-tier security validation to AutoBuild: quick checks (Phase 4.3, always run) for critical vulnerabilities, plus full security-specialist review (Phase 2.5C, conditional) for security-tagged tasks. Coach READS results only (no agent invocation)."
created: "2026-01-24T15:00:00Z"
updated: "2026-01-24T17:00:00Z"
status: planned
architecture_review: TASK-REV-4B0F
complexity: 5
estimated_tasks: 6

tasks:
  # Wave 1: Foundation (Parallel - 2 tasks)
  - id: TASK-SEC-001
    name: "Add quick security checks to Coach agent"
    file_path: "tasks/backlog/coach-security-integration/TASK-SEC-001-quick-security-checks.md"
    complexity: 5
    dependencies: []
    status: pending
    implementation_mode: task-work
    estimated_minutes: 150

  - id: TASK-SEC-002
    name: "Add security configuration schema"
    file_path: "tasks/backlog/coach-security-integration/TASK-SEC-002-security-config-schema.md"
    complexity: 3
    dependencies: []
    status: pending
    implementation_mode: task-work
    estimated_minutes: 90

  # Wave 2: Pre-Loop Security Integration (Parallel - 2 tasks, depends on Wave 1)
  # REVISED (TASK-REV-4B0F): Security runs in pre-loop, NOT Coach
  - id: TASK-SEC-003
    name: "Implement pre-loop security review via TaskWorkInterface"
    file_path: "tasks/backlog/coach-security-integration/TASK-SEC-003-security-specialist-invocation.md"
    complexity: 6
    dependencies:
      - TASK-SEC-001
      - TASK-SEC-002
    status: pending
    implementation_mode: task-work
    estimated_minutes: 240

  - id: TASK-SEC-004
    name: "Implement pre-loop security tag detection"
    file_path: "tasks/backlog/coach-security-integration/TASK-SEC-004-task-tagging-detection.md"
    complexity: 3
    dependencies:
      - TASK-SEC-001
      - TASK-SEC-002
    status: pending
    implementation_mode: task-work
    estimated_minutes: 90

  # Wave 3: Testing (Sequential - depends on Wave 2)
  - id: TASK-SEC-005
    name: "Add security validation tests for revised architecture"
    file_path: "tasks/backlog/coach-security-integration/TASK-SEC-005-security-validation-tests.md"
    complexity: 5
    dependencies:
      - TASK-SEC-001
      - TASK-SEC-002
      - TASK-SEC-003
      - TASK-SEC-004
    status: pending
    implementation_mode: task-work
    estimated_minutes: 180

  # Wave 4: Documentation (after testing)
  - id: TASK-SEC-006
    name: "Update security validation documentation for revised architecture"
    file_path: "tasks/backlog/coach-security-integration/TASK-SEC-006-coach-documentation-update.md"
    complexity: 2
    dependencies:
      - TASK-SEC-005
    status: pending
    implementation_mode: direct
    estimated_minutes: 120

orchestration:
  parallel_groups:
    # Wave 1: Foundation (2 tasks in parallel)
    - - TASK-SEC-001
      - TASK-SEC-002
    # Wave 2: Pre-Loop Security Integration (2 tasks in parallel after Wave 1)
    # REVISED (TASK-REV-4B0F): Security runs in pre-loop Phase 2.5C
    - - TASK-SEC-003
      - TASK-SEC-004
    # Wave 3: Testing (sequential after Wave 2)
    - - TASK-SEC-005
    # Wave 4: Documentation (after testing)
    - - TASK-SEC-006
  estimated_duration_minutes: 870  # Updated with revised estimates
  recommended_parallel: 2

# Metadata
parent_review: TASK-REV-SEC1
source_patterns:
  - "Substring matching for simple patterns (10x faster than regex)"
  - "Path-based filtering to limit checks to relevant file types"
  - "10-category vulnerability taxonomy from Claude Code"
  - "Confidence scoring (filter below 0.8)"
  - "Hard exclusion categories (DOS, rate limiting, resource management)"
  - "Environment variable override (GUARDKIT_SECURITY_SKIP)"

quality_targets:
  solid: 85
  dry: 85
  yagni: 90
  test_coverage: 90

# Files Affected (REVISED from TASK-REV-4B0F)
files_affected:
  new_files:
    - "guardkit/orchestrator/quality_gates/security_checker.py"
    - "guardkit/orchestrator/quality_gates/security_detection.py"  # Pre-loop detection
    - "guardkit/orchestrator/quality_gates/security_review.py"     # Full review parsing
    - "docs/guides/security-validation.md"
    - "tests/unit/test_security_checker.py"
    - "tests/unit/test_security_config.py"
    - "tests/unit/test_security_detection.py"
    - "tests/unit/test_security_review.py"
    - "tests/unit/test_security_filtering.py"
    - "tests/integration/test_pre_loop_security.py"   # Pre-loop Phase 2.5C tests
    - "tests/integration/test_task_work_security.py"  # Task-work Phase 4.3 tests
    - "tests/integration/test_coach_security.py"      # Coach read-only tests
    - "tests/fixtures/security/vulnerable_code/"
    - "tests/fixtures/security/safe_code/"
  modified_files:
    - "guardkit/orchestrator/quality_gates/__init__.py"
    - "guardkit/orchestrator/quality_gates/pre_loop.py"          # Add Phase 2.5C
    - "guardkit/orchestrator/quality_gates/task_work_interface.py"  # Add execute_security_review()
    - "guardkit/orchestrator/quality_gates/coach_validator.py"   # Read-only security verification
    - ".claude/agents/autobuild-coach.md"
    - "installer/core/commands/feature-build.md"
    - "CLAUDE.md"

# Security Configuration
security:
  level: strict
  force_full_review: true
