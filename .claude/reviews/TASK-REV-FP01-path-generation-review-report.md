# Review Report: TASK-REV-FP01 (Path Generation Bug)

## Executive Summary

The `/feature-plan` command generates invalid task file paths in the feature YAML, causing `feature-build` to fail validation for all tasks. **Two distinct bugs** produce this failure: (1) a duplicated directory segment, and (2) a filename slug mismatch. Both stem from a fundamental architecture issue: **two independent code paths construct paths that should be identical but use different logic**.

**Severity**: High - blocks all feature builds for any feature created via `/feature-plan`
**Confidence**: High - root causes confirmed via code analysis with matching evidence

---

## Review Details

- **Mode**: Root Cause Analysis (bug investigation)
- **Depth**: Standard
- **Task**: TASK-REV-FP01
- **Feature Affected**: FEAT-D4CE (Design mode for Player-Coach loops) and all future features

---

## Finding 1: Duplicated Directory Segment in YAML Paths

**Severity**: Critical

### Evidence

```yaml
# YAML records (WRONG - doubled segment):
file_path: tasks/backlog/design-mode-player-coach/design-mode-player-coach/TASK-DM-001-...md

# Actual file on disk (CORRECT - single segment):
tasks/backlog/design-mode-player-coach/TASK-DM-001-...md
```

All 8 tasks in FEAT-D4CE.yaml exhibit this pattern.

### Root Cause

The `build_task_file_path()` function in `generate_feature_yaml.py:147-186` constructs paths as:
```python
return f"{base_path}/{feature_slug}/{filename}"
```

The function was called with `base_path` already containing the feature slug (i.e., `tasks/backlog/design-mode-player-coach`) AND `feature_slug="design-mode-player-coach"`, producing:
```
tasks/backlog/design-mode-player-coach/design-mode-player-coach/TASK-DM-001-...md
```

This happened because the `/feature-plan` execution (driven by Claude following the command spec) passed `--task-base-path` set to the subfolder path (which includes the feature slug) while also passing `--feature-slug`. The function blindly concatenates both, doubling the segment.

### Location

- Path construction: `installer/core/commands/lib/generate_feature_yaml.py:183-184`
- Called from: `generate_feature_yaml.py:227` (parse_task_string) and `generate_feature_yaml.py:409-411` (JSON input)

---

## Finding 2: Filename Slug Mismatch Between YAML and Disk

**Severity**: Critical

### Evidence

```
# YAML filename:    TASK-DM-001-extend-task-frontmatter-for-design-urls.md
# Actual filename:  TASK-DM-001-extend-task-frontmatter-design-urls.md
#                                                       ^^^ "for-" missing
```

### Root Cause

**Two separate slug generators** produce different output for the same input:

1. **`slugify_task_name()`** in `generate_feature_yaml.py:119-144`:
   - Uses `re.sub(r'[^a-z0-9]+', '-', slug)` - preserves all words
   - No length limit
   - Result for "Extend task frontmatter for design URLs": `extend-task-frontmatter-for-design-urls`

2. **`_slugify()`** in `implement_orchestrator.py:568-584`:
   - Uses character-by-character filtering
   - **50 character limit** (line 582): `if len(slug) > 50: slug = slug[:50].rstrip('-')`
   - Result varies due to truncation and different character handling

The actual task files are created by `implement_orchestrator.py` (Step 8 of the [I]mplement flow), but the YAML is generated by `generate_feature_yaml.py` (Step 10). These use different slug functions, so the filenames diverge.

### Impact

Even if the directory duplication (Finding 1) is fixed, filenames still won't match between YAML and disk for many task names.

### Location

- YAML slug: `installer/core/commands/lib/generate_feature_yaml.py:119-144`
- Disk slug: `installer/core/lib/implement_orchestrator.py:568-584`

---

## Finding 3: Ambiguous Command Spec (5-field vs 4-field format)

**Severity**: Medium

### Evidence

The command spec (Step 10 at `feature-plan.md:1592-1610`) documents a **5-field format**:
```
--task "ID:NAME:FILE_PATH:COMPLEXITY:DEPS"
```

But `parse_task_string()` only handles a **4-field format**:
```python
parts = task_str.split(":", 3)  # Splits into at most 4 parts
```

If Claude passes 5 fields, the `NAME` field absorbs `FILE_PATH`, and `build_task_file_path()` re-derives the path from `--feature-slug` anyway. The FILE_PATH in the `--task` argument is silently ignored.

### Location

- Spec: `installer/core/commands/feature-plan.md:1592-1610`
- Parser: `installer/core/commands/lib/generate_feature_yaml.py:209`

---

## Finding 4: No Post-Creation Path Validation

**Severity**: Medium

### Evidence

The `/feature-plan` command creates task files on disk (Step 9) and generates the YAML (Step 10) as two independent operations. There is **no validation step** that verifies paths in the YAML resolve to actual files.

The `FeatureLoader.validate_feature()` at `feature_loader.py:645-648` correctly validates at load time, but this only runs during `feature-build` - not during `feature-plan`. By then, the user has already moved on.

---

## Recommendations

### R1: Unify Slug Generation (Critical - fixes Finding 2)

Create a **single shared** slug function used by both `generate_feature_yaml.py` and `implement_orchestrator.py`.

**Implementation**:
- Extract `slugify_task_name()` from `generate_feature_yaml.py` into a shared utility
- Replace `_slugify()` in `implement_orchestrator.py` with a call to the shared function
- Ensure both have the same length limit behavior

**Effort**: 1-2 hours
**Risk**: Low

### R2: Fix Path Construction to Prevent Doubling (Critical - fixes Finding 1)

Add a guard to `build_task_file_path()` that prevents `feature_slug` from being appended when `base_path` already ends with it:

```python
def build_task_file_path(task_id, feature_slug, base_path="tasks/backlog", task_name=""):
    if feature_slug:
        # Guard: don't double the slug if base_path already contains it
        if base_path.rstrip('/').endswith(feature_slug):
            return f"{base_path}/{filename}"
        return f"{base_path}/{feature_slug}/{filename}"
```

Alternatively (simpler): ensure the caller always passes `base_path="tasks/backlog"`, never the subfolder path.

**Effort**: 30 min - 1 hour
**Risk**: Low

### R3: Simplify `--task` Format to 4 Fields (Recommended - fixes Finding 3)

Update `feature-plan.md` Step 10 to use the 4-field format `ID:NAME:COMPLEXITY:DEPS` and rely solely on `--feature-slug` for path derivation. This removes the ambiguity of two path sources.

**Effort**: 30 min
**Risk**: None

### R4: Add Post-Creation Path Validation (Recommended - fixes Finding 4)

After YAML generation in Step 10, add validation that reads back the YAML and checks each `file_path` exists on disk. Report errors immediately rather than deferring to `feature-build`.

**Effort**: 1-2 hours
**Risk**: None

### R5: Fix FEAT-D4CE.yaml Immediately (Quick Fix)

Correct the 8 invalid paths in `.guardkit/features/FEAT-D4CE.yaml` to match the actual files on disk:

| YAML path (current) | Correct path |
|---------------------|-------------|
| `.../design-mode-player-coach/design-mode-player-coach/TASK-DM-001-extend-task-frontmatter-for-design-urls.md` | `tasks/backlog/design-mode-player-coach/TASK-DM-001-extend-task-frontmatter-design-urls.md` |
| (similar pattern for all 8 tasks) | |

**Effort**: 5 minutes
**Risk**: None

---

## Decision Matrix

| Fix | Impact | Effort | Risk | Priority |
|-----|--------|--------|------|----------|
| R5: Fix FEAT-D4CE.yaml | Unblocks 1 feature | 5 min | None | **Immediate** |
| R1: Unify slug generation | Prevents all filename mismatches | 1-2 hrs | Low | **Critical** |
| R2: Fix path doubling | Prevents all directory duplication | 30 min - 1 hr | Low | **Critical** |
| R3: Simplify --task format | Removes spec ambiguity | 30 min | None | Recommended |
| R4: Add validation step | Catches future regressions | 1-2 hrs | None | Recommended |

**Total effort for full fix**: ~4-6 hours

---

## Appendix

### Affected Files

| File | Role | Issue |
|------|------|-------|
| `installer/core/commands/lib/generate_feature_yaml.py:119-186` | YAML path + slug | `slugify_task_name()` + `build_task_file_path()` |
| `installer/core/lib/implement_orchestrator.py:568-584` | Disk file creation | `_slugify()` with different algorithm + 50 char limit |
| `installer/core/commands/feature-plan.md:1585-1622` | Command spec Step 10 | 5-field format vs 4-field parser |
| `guardkit/orchestrator/feature_loader.py:645-648` | Validation | Catches bug too late (at build time) |
| `.guardkit/features/FEAT-D4CE.yaml` | Feature file | Contains 8 invalid paths |
| `tests/unit/test_generate_feature_yaml.py` | Tests | No cross-validation test with implement_orchestrator |

### Slug Function Comparison

| Input | `slugify_task_name()` | `_slugify()` (50 char limit) |
|-------|----------------------|-------------|
| "Extend task frontmatter for design URLs" | `extend-task-frontmatter-for-design-urls` (41 chars) | `extend-task-frontmatter-for-design-urls` (41 chars) |
| "Implement MCP facade for design extraction" | `implement-mcp-facade-for-design-extraction` (44 chars) | `implement-mcp-facade-for-design-extraction` (44 chars) |
| "Add design change detection and state-aware handling" | `add-design-change-detection-and-state-aware-handling` (53 chars) | `add-design-change-detection-and-state-aware-handli` (50 chars, **truncated**) |

### Actual vs YAML Filenames for FEAT-D4CE

| Task | YAML Filename | Actual Filename | Match? |
|------|--------------|-----------------|--------|
| DM-001 | `TASK-DM-001-extend-task-frontmatter-for-design-urls.md` | `TASK-DM-001-extend-task-frontmatter-design-urls.md` | NO |
| DM-002 | `TASK-DM-002-implement-mcp-facade-for-design-extraction.md` | `TASK-DM-002-implement-mcp-facade-design-extraction.md` | NO |
| DM-003 | `TASK-DM-003-implement-phase-0-design-extraction-in-autobuild.md` | `TASK-DM-003-implement-phase-0-design-extraction-autobuild.md` | NO |
| DM-004 | `TASK-DM-004-generate-prohibition-checklist-from-design-data.md` | `TASK-DM-004-generate-prohibition-checklist.md` | NO |
| DM-005 | `TASK-DM-005-implement-browserverifier-abstraction.md` | `TASK-DM-005-implement-browser-verifier-abstraction.md` | NO |
| DM-006 | `TASK-DM-006-implement-ssim-comparison-pipeline.md` | `TASK-DM-006-implement-ssim-comparison-pipeline.md` | YES |
| DM-007 | `TASK-DM-007-integrate-design-context-into-player-coach-prompts.md` | `TASK-DM-007-integrate-design-context-player-coach-prompts.md` | NO |
| DM-008 | `TASK-DM-008-add-design-change-detection-and-state-aware-handling.md` | `TASK-DM-008-add-design-change-detection.md` | NO |

Only 1 of 8 filenames matches. The pattern shows the YAML versions are consistently more verbose (include prepositions like "for", "in", "from", "into") while the actual files use shorter slugs.

This confirms the two slug functions produce different outputs, AND that the task names fed to each function may differ (the YAML generator uses the full task name, while the implement orchestrator may use a truncated/cleaned version).
