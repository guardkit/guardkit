# Review Report: TASK-REV-DM01

## Executive Summary

**Issue**: The `/agent-enhance` command is not generating discovery metadata (`stack`, `phase`, `capabilities`, `keywords`) in agent frontmatter.

**Root Cause Identified**: The discovery metadata fields are **never requested from the AI** in the prompt, and there is **no code path** to generate or inject these fields anywhere in the enhancement pipeline.

**Fix Location**: `installer/core/lib/agent_enhancement/prompt_builder.py` (primary) with supporting changes in `parser.py` and `applier.py`.

**Estimated Complexity**: 4/10 (Medium - requires prompt changes + JSON schema updates + applier logic)

---

## Review Details

- **Mode**: Code Quality Review
- **Depth**: Standard
- **Duration**: ~45 minutes
- **Files Analyzed**: 12 primary files, 7 output logs

---

## Findings

### Finding 1: Prompt Builder Never Requests Discovery Metadata

**Location**: [prompt_builder.py:69-151](installer/core/lib/agent_enhancement/prompt_builder.py#L69-L151)

**Evidence**: The JSON schema in `prompt_builder.py` lines 86-114 specifies only:
```json
{
  "required": ["sections", "related_templates", "examples", "boundaries"],
  "properties": {
    "sections": {...},
    "related_templates": {...},
    "examples": {...},
    "boundaries": {...}
  }
}
```

**Missing Fields**: `stack`, `phase`, `capabilities`, `keywords` are not:
- Listed in `required` array
- Defined in `properties` object
- Mentioned anywhere in the prompt text

**Impact**: The AI cannot return what it isn't asked for. This is the PRIMARY ROOT CAUSE.

---

### Finding 2: Parser Does Not Validate or Extract Discovery Metadata

**Location**: [parser.py:139-188](installer/core/lib/agent_enhancement/parser.py#L139-L188)

**Evidence**: The `_validate_basic_structure()` method only checks for:
- `sections` key existence
- `boundaries` field presence and format

**Missing Validation**: No validation or extraction logic for `stack`, `phase`, `capabilities`, `keywords`.

---

### Finding 3: Applier Has No Logic to Inject Discovery Metadata into Frontmatter

**Location**: [applier.py:151-254](installer/core/lib/agent_enhancement/applier.py#L151-L254)

**Evidence**: The `_merge_content()` method:
1. Preserves existing frontmatter (lines 175-187)
2. Handles `boundaries` section specially (lines 196-232)
3. Appends other sections at the end (lines 238-252)

**Missing Logic**: No code path to:
- Parse discovery metadata from AI response
- Inject new fields into YAML frontmatter
- Preserve existing frontmatter while adding new discovery fields

---

### Finding 4: Command Documentation Claims Metadata Generation but Implementation Doesn't Support It

**Location**: [agent-enhance.md:372-400](installer/core/commands/agent-enhance.md#L372-L400)

**Evidence**: The documentation states:
> "As of HAI-001 (Nov 2025), agents enhanced via `/agent-enhance` include **discovery metadata**"
> - `stack`: List of supported technology stacks
> - `phase`: Agent role
> - `capabilities`: 5+ specific skills
> - `keywords`: 5+ searchable terms

**Reality**: The implementation does NOT generate this metadata. This is a documentation/implementation mismatch.

---

### Finding 5: One Agent (svelte-list-view-specialist) Has Complete Metadata - Manually Added

**Evidence**:
- Output log shows AI returned standard sections without metadata
- Final file has complete discovery metadata (lines 5-27)
- No git history for these files (not yet committed)
- svelte-list-view-specialist was likely manually edited after enhancement

**Conclusion**: The svelte-list-view-specialist metadata was manually added post-enhancement, not generated by the system.

---

### Finding 6: agent-content-enhancer Agent Prompt Also Doesn't Mention Discovery Metadata

**Location**: [agent-content-enhancer.md:114-122](installer/core/agents/agent-content-enhancer.md#L114-L122)

**Evidence**: The "Enhancement Structure" section (lines 114-122) defines header structure as:
```yaml
---
name: agent-name
description: One-line description
tools: [Read, Write, Edit, Grep, Glob]
tags: [relevant, tags]
---
```

**Missing**: No mention of `stack`, `phase`, `capabilities`, `keywords` anywhere in the agent documentation.

---

## Code Path Analysis

```
Request Flow:
1. agent-enhance.py → orchestrator.run()
2. orchestrator.run() → enhancer.enhance()
3. enhancer.enhance() → _generate_enhancement() → _ai_enhancement()
4. _ai_enhancement() → prompt_builder.build()  ← NO METADATA REQUESTED
5. AI returns JSON without metadata fields
6. parser.parse() → validates basic structure ← NO METADATA VALIDATION
7. applier.apply() or apply_with_split() ← NO METADATA INJECTION INTO FRONTMATTER
8. Result: Agent file enhanced but frontmatter unchanged
```

---

## Recommendations

### Recommendation 1: Update Prompt Builder Schema (HIGH PRIORITY)

**File**: `installer/core/lib/agent_enhancement/prompt_builder.py`

**Changes Required**:
1. Add discovery metadata fields to JSON schema (lines 86-114)
2. Add explicit instructions for AI to analyze code and generate:
   - `stack`: Based on file extensions, imports, package.json, etc.
   - `phase`: Based on agent name/description patterns
   - `capabilities`: From template analysis
   - `keywords`: From agent name + common search terms

**Example Schema Addition**:
```python
"frontmatter_metadata": {
    "type": "object",
    "required": ["stack", "phase", "capabilities", "keywords"],
    "properties": {
        "stack": {
            "type": "array",
            "items": {"type": "string"},
            "minItems": 1,
            "description": "Technology stacks (e.g., ['svelte', 'javascript'])"
        },
        "phase": {
            "type": "string",
            "enum": ["implementation", "review", "testing", "orchestration", "debugging"],
            "description": "Agent's primary role phase"
        },
        "capabilities": {
            "type": "array",
            "items": {"type": "string"},
            "minItems": 5,
            "description": "Specific skills (5+ items)"
        },
        "keywords": {
            "type": "array",
            "items": {"type": "string"},
            "minItems": 5,
            "description": "Searchable terms for agent discovery"
        }
    }
}
```

---

### Recommendation 2: Update Applier to Merge Frontmatter Metadata

**File**: `installer/core/lib/agent_enhancement/applier.py`

**Changes Required**:
1. Add method `_merge_frontmatter_metadata(original_content, new_metadata) -> str`
2. Parse YAML frontmatter using `frontmatter` library
3. Merge new discovery fields into existing frontmatter
4. Serialize back to YAML
5. Call this method in `_merge_content()` before handling sections

---

### Recommendation 3: Update Parser to Validate Metadata Structure

**File**: `installer/core/lib/agent_enhancement/parser.py`

**Changes Required**:
1. Add `_validate_metadata()` method
2. Validate `frontmatter_metadata` field presence
3. Validate required subfields (`stack`, `phase`, `capabilities`, `keywords`)
4. Add to `_validate_basic_structure()` call chain

---

### Recommendation 4: Update Agent Documentation

**File**: `installer/core/agents/agent-content-enhancer.md`

**Changes Required**:
1. Add discovery metadata fields to "Enhancement Structure" section
2. Add examples showing how to derive each field
3. Add validation examples showing correct format

---

### Recommendation 5: Add Integration Tests

**New File**: `tests/lib/agent_enhancement/test_discovery_metadata.py`

**Test Cases**:
1. Test prompt includes metadata schema
2. Test parser validates metadata fields
3. Test applier merges metadata into frontmatter
4. Test end-to-end enhancement produces complete frontmatter

---

## Decision Matrix

| Fix Component | Effort | Risk | Priority | Recommendation |
|--------------|--------|------|----------|----------------|
| Prompt Builder | Medium | Low | HIGH | Required - primary fix |
| Applier (frontmatter merge) | Medium | Medium | HIGH | Required - enables output |
| Parser (validation) | Low | Low | MEDIUM | Recommended - prevents silent failures |
| Agent Documentation | Low | Low | MEDIUM | Recommended - AI guidance |
| Integration Tests | Medium | Low | MEDIUM | Recommended - regression prevention |

---

## Impact Assessment

**Without Fix**:
- Agent discovery system cannot find specialists automatically
- Manual metadata addition required for each agent
- HAI-001 feature incomplete
- Documentation is misleading

**With Fix**:
- Automatic specialist selection in Phase 3
- 48-53% cost savings via Haiku agents (as documented)
- 4-5x faster implementation (as documented)
- No hardcoded mappings (extensible)

---

## Related Issues Discovered

1. **TASK-FIX-INV01**: Response file naming mismatch (`.agent-response.json` vs `.agent-response-phase8.json`) - causes manual intervention needed
2. **svelte-form-specialist-ext.md**: Only 1,297 bytes vs 5,000-10,000 bytes for others - may indicate incomplete enhancement

---

## Definition of Done Verification

| Acceptance Criteria | Status |
|---------------------|--------|
| AC1: Root cause identified | ✅ Prompt never requests metadata |
| AC2: Evidence collected | ✅ Output logs, code analysis complete |
| AC3: Fix location identified | ✅ prompt_builder.py (primary), applier.py, parser.py |
| AC4: Recommendations documented | ✅ 5 specific recommendations with code locations |

---

## Appendix: Files Analyzed

### Primary Investigation
- `installer/core/lib/agent_enhancement/prompt_builder.py`
- `installer/core/lib/agent_enhancement/enhancer.py`
- `installer/core/lib/agent_enhancement/parser.py`
- `installer/core/lib/agent_enhancement/applier.py`
- `installer/core/lib/agent_enhancement/orchestrator.py`
- `installer/core/agents/agent-content-enhancer.md`
- `installer/core/commands/agent-enhance.md`

### Evidence Sources
- `docs/reviews/progressive-disclosure/agent-enhance-output/*.md` (7 files)
- `docs/reviews/progressive-disclosure/kartlog/agents/*.md` (14 files)

---

*Report generated: 2025-12-09*
*Review mode: code-quality*
*Review depth: standard*
