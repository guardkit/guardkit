# Review Report: TASK-REV-FC01

## Executive Summary

This decision review analyzes the design of `/feature-complete` command - the feature-level counterpart to `/task-complete`. The command must handle task completion rollup, feature folder archival, and platform-agnostic git merge/PR workflows.

**Key Decisions Required:**
1. Merge strategy detection mechanism
2. PR/MR creation workflow
3. Task completion parallelization
4. Worktree cleanup policy

**Recommended Approach:** Layered configuration with auto-detection fallback, supporting direct merge (default) with optional PR workflows for team environments.

---

## Review Details

| Field | Value |
|-------|-------|
| **Task ID** | TASK-REV-FC01 |
| **Mode** | Decision Analysis |
| **Depth** | Standard |
| **Complexity** | 7/10 |
| **Duration** | ~2 hours |

---

## Analysis: Open Questions

### Question 1: Merge Strategy Selection

**Current State:** No merge strategy detection exists. Users manually merge.

**Options Evaluated:**

| Option | Approach | Pros | Cons |
|--------|----------|------|------|
| **A. Auto-detect from git remotes** | Parse `.git/config` for remote URLs, infer platform | Zero config, "just works" | May detect wrong platform (multiple remotes) |
| **B. User config in `.guardkit/config.yaml`** | Explicit setting: `merge_strategy: github_pr` | Clear user intent | Requires upfront setup |
| **C. Interactive prompt** | Ask on first run, save preference | User-friendly, one-time | Interrupts automation |
| **D. CLI flag override** | `--strategy=pr` or `--direct` | Flexible per-invocation | Verbose for common case |
| **E. Layered: Config â†’ Auto-detect â†’ Prompt** | Cascade through options | Best of all worlds | Slightly complex |

**Recommendation: Option E (Layered)**

```
Priority cascade:
1. CLI flag (--strategy=...) â†’ highest priority
2. .guardkit/config.yaml â†’ team-wide setting
3. Auto-detect from git remote â†’ works out of box
4. Interactive prompt â†’ fallback for ambiguous cases
```

**Rationale:**
- Solo devs: Auto-detection works immediately
- Teams: Config file provides consistency
- CI/CD: CLI flags enable automation
- Edge cases: Prompt handles ambiguity

---

### Question 2: PR/MR Creation Workflow

**Options Evaluated:**

| Option | Behavior | Pros | Cons |
|--------|----------|------|------|
| **A. Create PR and return immediately** | Non-blocking, returns PR URL | Fast, doesn't wait for humans | User must track PR separately |
| **B. Create PR and wait for approval** | Blocks until merged | Complete automation | Very slow, risky in automation |
| **C. Create PR, poll status briefly, return** | Create + 30s status check | Catches immediate failures | Still returns early |
| **D. Dry-run mode first** | Show what would happen, then execute | Safe, educational | Extra step |

**Recommendation: Option A with Option D as flag**

```bash
# Default: Create and return immediately
/feature-complete FEAT-A96D
# â†’ Creates PR, shows URL, returns immediately

# Preview mode: Show what would happen
/feature-complete FEAT-A96D --dry-run
# â†’ Shows merge strategy, branch, files changed, exits

# Wait mode (for CI): Wait up to N seconds for merge
/feature-complete FEAT-A96D --wait-for-merge=300
# â†’ Creates PR, polls for 300s, returns merged/pending
```

**PR Template Recommendation:**

```markdown
## Summary
Feature: {feature_name} ({feature_id})
Tasks: {tasks_completed}/{total_tasks} completed

### Tasks Included
{for each task}
- [x] {task_id}: {task_title}
{end for}

## Changes
{auto-generated diff summary}

## Test Plan
- All tasks passed Coach validation
- Quality gates: {gates_summary}

---
ðŸ¤– Auto-generated by GuardKit `/feature-complete`
```

---

### Question 3: Direct Merge Workflow

For teams/users NOT using PRs:

**Recommendation:**

| Decision Point | Recommendation | Rationale |
|----------------|----------------|-----------|
| Target branch | Configurable, default `main` | `develop` common in GitFlow |
| Merge type | `--no-ff` merge commit | Preserves feature history |
| Auto-push | **Off by default**, `--push` flag | User confirms before pushing |

```bash
# Direct merge (no PR)
/feature-complete FEAT-A96D --strategy=direct

# With auto-push
/feature-complete FEAT-A96D --strategy=direct --push
```

---

### Question 4: Task Completion Parallelization

**Context:** Feature with 5 tasks takes ~5s Ã— 5 = 25s if sequential.

**Recommendation: Parallel with sequential fallback**

```python
# Pseudocode
if all_tasks_in_single_worktree:
    # Parallel safe: No git conflicts between task completions
    await asyncio.gather(*[complete_task(t) for t in tasks])
else:
    # Sequential for safety
    for task in tasks:
        await complete_task(task)
```

**Failure Mode:** If one task completion fails:
1. Log warning, continue with others
2. At end, report which failed
3. Do NOT block feature completion if task is already in worktree

---

### Question 5: Worktree Cleanup Policy

**Recommendation: Conditional Cleanup**

| Merge Strategy | After Success | After Failure |
|----------------|---------------|---------------|
| Direct merge | Cleanup worktree | **Preserve** (debug) |
| PR created | Preserve until PR merged | Preserve |
| PR merged | Cleanup worktree | N/A |

**Implementation:**

```yaml
# .guardkit/config.yaml
worktree_cleanup:
  on_success: auto        # auto | manual | preserve
  on_failure: preserve    # always preserve for debugging
  on_pr_created: preserve # keep until PR merged
```

**Cleanup command for manual control:**
```bash
guardkit worktree cleanup FEAT-A96D
```

---

### Question 6: Feature State Transitions

**Recommended State Machine:**

```
feature-build SUCCESS
    â”‚
    â–¼
AWAITING_REVIEW  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                            â”‚
    â–¼ (user runs /feature-complete)             â”‚
    â”‚                                            â”‚
    â”œâ”€â”€â”€ --dry-run â”€â”€â”€â–º (shows plan, exits)     â”‚
    â”‚                                            â”‚
    â–¼                                            â”‚
COMPLETING                                       â”‚
    â”‚                                            â”‚
    â”œâ”€â”€â”€ Direct merge â”€â”€â”€â–º MERGING              â”‚
    â”‚                          â”‚                 â”‚
    â”‚                          â–¼                 â”‚
    â”‚                      SUCCESS â”€â”€â”€â–º COMPLETED (archived)
    â”‚                          â”‚
    â”‚                      FAILED â”€â”€â”€â”€â–º AWAITING_REVIEW (retry)
    â”‚
    â””â”€â”€â”€ PR workflow â”€â”€â”€â”€â–º PR_CREATED
                               â”‚
                               â”œâ”€â”€â”€ PR merged (webhook/poll) â”€â”€â”€â–º COMPLETED
                               â”‚
                               â””â”€â”€â”€ PR closed â”€â”€â”€â–º AWAITING_REVIEW
```

**Feature YAML Updates:**

```yaml
# .guardkit/features/FEAT-A96D.yaml
status: completed  # or: awaiting_review, completing, pr_created, failed
completion:
  strategy: github_pr  # or: direct, gitlab_mr, azure_pr, bitbucket_pr
  started_at: "2026-01-24T10:00:00Z"
  completed_at: "2026-01-24T10:05:00Z"
  pr_url: "https://github.com/org/repo/pull/123"  # if PR
  pr_number: 123
  merged_by: "auto"  # or: user@example.com
  worktree_cleaned: true
```

---

### Question 7: Rollback/Recovery

**Failure Scenarios:**

| Failure | Recovery Action |
|---------|-----------------|
| Task completion fails | Log warning, continue, report at end |
| PR creation fails (auth) | Display error with `gh auth login` instructions |
| PR creation fails (branch) | Check if PR already exists, provide URL |
| Merge conflict | Preserve worktree, display manual resolution steps |
| Network timeout | Retry with exponential backoff (3 attempts) |

**Retry Command:**
```bash
# Resume from where it failed
/feature-complete FEAT-A96D --resume
```

---

## Architecture Decision Record (ADR)

### ADR-001: Feature Completion Merge Strategy Architecture

**Status:** Proposed

**Context:**
The `/feature-complete` command needs to support multiple git platforms (GitHub, GitLab, Azure DevOps, Bitbucket) and multiple merge strategies (direct merge, PR/MR). The codebase already has a `CommandExecutor` protocol pattern that enables dependency injection for testability.

**Decision:**
Implement a **Strategy Pattern** with platform-specific handlers:

```
guardkit/orchestrator/
â”œâ”€â”€ feature_complete.py         # Main orchestrator
â”œâ”€â”€ merge_strategy/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ detector.py             # Platform detection from git remotes
â”‚   â”œâ”€â”€ base.py                 # Abstract MergeStrategy protocol
â”‚   â”œâ”€â”€ direct_merge.py         # Direct git merge (no PR)
â”‚   â”œâ”€â”€ github_handler.py       # GitHub PR via `gh` CLI
â”‚   â”œâ”€â”€ gitlab_handler.py       # GitLab MR via `glab` CLI
â”‚   â”œâ”€â”€ azure_handler.py        # Azure DevOps via `az` CLI
â”‚   â””â”€â”€ bitbucket_handler.py    # Bitbucket via API or CLI
```

**Protocol Definition:**

```python
from typing import Protocol, Optional
from dataclasses import dataclass

@dataclass(frozen=True)
class MergeResult:
    """Result of merge/PR operation."""
    success: bool
    strategy: str  # "direct", "github_pr", etc.
    pr_url: Optional[str] = None
    pr_number: Optional[int] = None
    merged: bool = False
    error: Optional[str] = None

class MergeStrategy(Protocol):
    """Protocol for merge strategy implementations."""

    def detect(self, remote_url: str) -> bool:
        """Returns True if this strategy handles the given remote."""
        ...

    def execute(
        self,
        worktree_path: Path,
        source_branch: str,
        target_branch: str,
        title: str,
        body: str,
    ) -> MergeResult:
        """Execute merge or PR creation."""
        ...

    def check_prerequisites(self) -> tuple[bool, str]:
        """Check if prerequisites (e.g., gh CLI) are installed."""
        ...
```

**Consequences:**
- **Positive:** Easy to add new platforms (just implement protocol)
- **Positive:** Testable via mock implementations
- **Positive:** Clear separation of concerns
- **Negative:** More files to maintain (one per platform)

---

## Command Specification: `/feature-complete`

### Syntax

```bash
/feature-complete FEAT-XXX [options]
```

### Options

| Flag | Description | Default |
|------|-------------|---------|
| `--strategy=STRATEGY` | Merge strategy: `auto`, `direct`, `github_pr`, `gitlab_mr`, `azure_pr`, `bitbucket_pr` | `auto` |
| `--target=BRANCH` | Target branch for merge | `main` |
| `--push` | Push after direct merge | `false` |
| `--dry-run` | Preview actions without executing | `false` |
| `--wait-for-merge=SECONDS` | Wait for PR merge (0=don't wait) | `0` |
| `--no-cleanup` | Don't cleanup worktree after success | `false` |
| `--resume` | Resume from interrupted completion | `false` |
| `--force` | Skip confirmation prompts | `false` |

### Execution Phases

```
Phase 1: Validation
â”œâ”€â”€ Verify feature exists and status is AWAITING_REVIEW
â”œâ”€â”€ Verify worktree exists and is clean
â”œâ”€â”€ Detect merge strategy (if --strategy=auto)
â””â”€â”€ Check prerequisites (gh/glab/az CLI)

Phase 2: Task Completion (Parallel)
â”œâ”€â”€ For each task in feature:
â”‚   â”œâ”€â”€ Run /task-complete TASK-XXX
â”‚   â””â”€â”€ Move task file to tasks/completed/FEAT-XXX/
â””â”€â”€ Handle failures (log, continue, report at end)

Phase 3: Feature Archival
â”œâ”€â”€ Move feature folder: tasks/backlog/{slug}/ â†’ tasks/completed/{date}/{slug}/
â”œâ”€â”€ Update feature YAML: .guardkit/features/FEAT-XXX.yaml
â””â”€â”€ Generate completion report

Phase 4: Merge/PR
â”œâ”€â”€ [Direct] git checkout main && git merge --no-ff autobuild/FEAT-XXX
â”œâ”€â”€ [PR] Create PR via platform CLI
â””â”€â”€ [Push] git push (if --push or PR workflow)

Phase 5: Cleanup (Optional)
â”œâ”€â”€ [Success + Direct] Remove worktree and branch
â”œâ”€â”€ [Success + PR] Preserve until merged (or --no-cleanup)
â””â”€â”€ [Failure] Always preserve for debugging
```

### Example Output

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FEATURE COMPLETE: FEAT-A96D
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Feature: FastAPI App with Health Endpoint
Status: AWAITING_REVIEW â†’ COMPLETING
Tasks: 5/5 completed

Phase 1: Validation
  âœ“ Feature file found: .guardkit/features/FEAT-A96D.yaml
  âœ“ Worktree exists: .guardkit/worktrees/FEAT-A96D
  âœ“ Merge strategy detected: github_pr (from remote origin)
  âœ“ GitHub CLI (gh) installed and authenticated

Phase 2: Task Completion
  âœ“ TASK-FHA-001: Archived to tasks/completed/2026-01-24/FEAT-A96D/
  âœ“ TASK-FHA-002: Archived to tasks/completed/2026-01-24/FEAT-A96D/
  âœ“ TASK-FHA-003: Archived to tasks/completed/2026-01-24/FEAT-A96D/
  âœ“ TASK-FHA-004: Archived to tasks/completed/2026-01-24/FEAT-A96D/
  âœ“ TASK-FHA-005: Archived to tasks/completed/2026-01-24/FEAT-A96D/
  All 5 tasks completed successfully

Phase 3: Feature Archival
  âœ“ Moved: tasks/backlog/fastapi-health/ â†’ tasks/completed/2026-01-24/fastapi-health/
  âœ“ Updated: .guardkit/features/FEAT-A96D.yaml (status: pr_created)

Phase 4: Pull Request
  âœ“ Created PR #127: "feat: FastAPI App with Health Endpoint (FEAT-A96D)"
  âœ“ URL: https://github.com/org/repo/pull/127

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ“ FEATURE COMPLETION: SUCCESS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PR Created: https://github.com/org/repo/pull/127
Worktree: .guardkit/worktrees/FEAT-A96D (preserved until PR merged)

Next Steps:
  1. Review PR: https://github.com/org/repo/pull/127
  2. Approve and merge PR
  3. Cleanup: guardkit worktree cleanup FEAT-A96D
```

---

## Configuration Schema

### `.guardkit/config.yaml`

```yaml
# GuardKit Configuration
version: "1.0"

# Feature completion settings
feature_complete:
  # Merge strategy: auto | direct | github_pr | gitlab_mr | azure_pr | bitbucket_pr
  strategy: auto

  # Target branch for merges
  target_branch: main

  # Auto-push after direct merge
  auto_push: false

  # Worktree cleanup policy
  worktree_cleanup:
    on_success: auto          # auto | manual | preserve
    on_failure: preserve      # always preserve for debugging
    on_pr_created: preserve   # keep until PR merged

  # PR/MR settings
  pr_settings:
    # Draft PRs (GitHub/GitLab only)
    draft: false

    # Request reviewers automatically
    auto_reviewers: []

    # Labels to apply
    labels:
      - guardkit
      - automated

    # PR title template (supports placeholders)
    title_template: "feat: {feature_name} ({feature_id})"

    # PR body template file (relative to repo root)
    body_template: ".guardkit/templates/pr-body.md"

# Task completion settings
task_complete:
  # Parallel task completion
  parallel: true

  # Continue on individual task failure
  continue_on_failure: true
```

---

## State Diagram

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚                     â”‚
                                    â”‚   /feature-build    â”‚
                                    â”‚      SUCCESS        â”‚
                                    â”‚                     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”‚   AWAITING_REVIEW    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                           â”‚                  â”‚                        â”‚
                           â”‚    /feature-complete                      â”‚
                           â”‚                  â”‚                        â”‚
                           â”‚                  â–¼                        â”‚
                           â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
                           â”‚       â”‚     COMPLETING      â”‚            â”‚
                           â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                           â”‚                  â”‚                        â”‚
                           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                           â”‚    â”‚             â”‚             â”‚         â”‚
                           â”‚    â–¼             â–¼             â–¼         â”‚
                           â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                           â”‚ â”‚Directâ”‚    â”‚ PR/MR    â”‚  â”‚ Failure  â”‚â”€â”€â”˜
                           â”‚ â”‚Merge â”‚    â”‚ Created  â”‚  â”‚          â”‚
                           â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚    â”‚             â”‚
                           â”‚    â”‚             â”œâ”€â”€â”€ PR Merged â”€â”€â”€â”€â”
                           â”‚    â”‚             â”‚                   â”‚
                           â”‚    â”‚             â””â”€â”€â”€ PR Closed â”€â”€â”€â”€â–ºâ”‚ (back to
                           â”‚    â”‚                                  â”‚ AWAITING_REVIEW)
                           â”‚    â”‚                                  â”‚
                           â”‚    â–¼                                  â–¼
                           â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚ â”‚              COMPLETED                   â”‚
                           â”‚ â”‚                                         â”‚
                           â”‚ â”‚  - Feature YAML archived                â”‚
                           â”‚ â”‚  - Tasks in tasks/completed/            â”‚
                           â”‚ â”‚  - Worktree cleaned (if configured)     â”‚
                           â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    --dry-run (exits without state change)
```

---

## Implementation Recommendations

### REVISED: Minimal Viable Wave 1 (Tool-Agnostic)

**Key Insight:** Users have their preferred git tools (GitKraken, Fork, Tower, Sourcetree, VS Code, command line). Rather than reinventing the merge/PR wheel, Wave 1 should **prepare everything** and let users complete the merge/PR step with their preferred tool.

#### Wave 1: "Prepare and Hand Off" (Minimal Scope)

**What `/feature-complete` does:**
1. âœ… Run `/task-complete` for all tasks (parallel)
2. âœ… Move feature folder to `tasks/completed/{date}/{slug}/`
3. âœ… Update feature YAML status to `awaiting_merge`
4. âœ… Display clear instructions for manual merge/PR
5. âœ… Provide cleanup command after user confirms merge

**What user does (with their preferred tool):**
- Open GitKraken/Fork/Tower â†’ merge or create PR
- OR use `gh pr create` / `glab mr create` if they prefer CLI
- OR just `git merge` from terminal

**Example Wave 1 Output:**

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FEATURE COMPLETE: FEAT-A96D
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Task Completion
  âœ“ TASK-FHA-001: Archived
  âœ“ TASK-FHA-002: Archived
  âœ“ TASK-FHA-003: Archived
  âœ“ TASK-FHA-004: Archived
  âœ“ TASK-FHA-005: Archived
  All 5 tasks completed

âœ“ Feature Archival
  âœ“ Moved to: tasks/completed/2026-01-24/fastapi-health/
  âœ“ Updated: .guardkit/features/FEAT-A96D.yaml

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“‹ READY FOR MERGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Branch: autobuild/FEAT-A96D
Target: main
Worktree: .guardkit/worktrees/FEAT-A96D

Use your preferred tool to complete the merge:

  GitKraken/Fork/Tower:
    1. Open the worktree folder
    2. Create PR or merge to main

  Command Line (direct merge):
    git checkout main
    git merge --no-ff autobuild/FEAT-A96D
    git push

  Command Line (GitHub PR):
    gh pr create --base main --head autobuild/FEAT-A96D

After merge, cleanup:
  guardkit worktree cleanup FEAT-A96D
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

#### Wave 1 Complexity (REVISED)

| Subtask | Complexity | Notes |
|---------|------------|-------|
| Core orchestrator skeleton | 3 | Simple phase execution |
| Task completion (parallel) | 3 | Reuse existing /task-complete |
| Feature folder archival | 2 | File moves, YAML update |
| Display merge instructions | 1 | Console output |
| Worktree cleanup command | 2 | Already exists in WorktreeManager |
| **Total** | **11** | ~1-2 days implementation |

**No CLI tool integration needed in Wave 1!**

---

### Future Waves (Optional Automation)

Only if users request automated PR creation:

| Wave | Scope | Complexity | When to Implement |
|------|-------|------------|-------------------|
| Wave 2 | GitHub `gh` CLI integration | 4 | If users request auto-PR |
| Wave 3 | GitLab `glab` / Azure `az` | 6 | On demand per team |
| Wave 4 | Auto-merge after approval | 3 | Enterprise teams only |

---

### Original Priority Order (For Reference)

| Phase | Subtask | Complexity | Dependencies |
|-------|---------|------------|--------------|
| 1 | Core feature-complete orchestrator skeleton | 4 | None |
| 1 | Direct merge strategy (no PR) | 3 | Orchestrator |
| 2 | Platform detection from git remotes | 3 | None |
| 2 | GitHub PR handler (via `gh` CLI) | 4 | Platform detection |
| 2 | Configuration schema extension | 3 | None |
| 3 | Task completion parallelization | 4 | Orchestrator |
| 3 | Feature folder archival logic | 3 | Orchestrator |
| 3 | Worktree cleanup policy | 3 | Orchestrator |
| 4 | GitLab MR handler (via `glab` CLI) | 3 | Platform detection |
| 4 | Azure DevOps PR handler (via `az` CLI) | 3 | Platform detection |
| 4 | Bitbucket PR handler | 4 | Platform detection |
| 5 | Resume/retry logic | 4 | Orchestrator |
| 5 | Wait-for-merge polling | 3 | PR handlers |

**Original Wave Execution (deferred):**

```
Wave 1: [Orchestrator skeleton, Direct merge, Config schema]
Wave 2: [Platform detection, GitHub handler, Task parallelization]
Wave 3: [Feature archival, Worktree cleanup, GitLab handler]
Wave 4: [Azure handler, Bitbucket handler, Resume logic]
```

---

## Findings Summary

| # | Finding | Severity | Recommendation |
|---|---------|----------|----------------|
| 1 | No existing merge strategy code | Info | Clean slate, use Strategy pattern |
| 2 | `CommandExecutor` protocol exists | Positive | Reuse for CLI tool invocations |
| 3 | Worktree cleanup is manual | Medium | Add configurable auto-cleanup |
| 4 | No PR template system | Medium | Add `.guardkit/templates/` |
| 5 | Task completion is serial | Low | Parallelize with asyncio |
| 6 | No feature archival path | Medium | Add `tasks/completed/{date}/{slug}/` |

---

## Recommendations Summary

### REVISED (Minimal Wave 1)

1. **No merge automation in Wave 1** - Just prepare and hand off to user's preferred tool
2. **Parallelize task completion** using existing asyncio patterns
3. **Preserve worktrees** until user confirms merge complete
4. **Display clear instructions** for GitKraken, Fork, Tower, or CLI users
5. **Add `guardkit worktree cleanup`** command for post-merge cleanup
6. **Defer CLI integration** (gh, glab, az) to future waves on demand

### Original (Deferred)

1. ~~Use layered configuration (CLI â†’ config file â†’ auto-detect â†’ prompt)~~
2. ~~Default to direct merge for simplicity; PRs opt-in~~
3. ~~Start with GitHub support (`gh` CLI), add others incrementally~~
4. ~~Implement Strategy pattern for extensibility~~

---

## Decision Matrix

| Option | Complexity | User Impact | Team Impact | Automation | Recommendation |
|--------|------------|-------------|-------------|------------|----------------|
| Direct merge only | Low | High (manual PRs) | Low | Good | Phase 1 MVP |
| GitHub PR only | Medium | Good | Good | Good | Phase 2 |
| All platforms | High | Excellent | Excellent | Excellent | Phase 3-4 |
| Full config system | Medium | Excellent | Excellent | Excellent | Phase 2 |

---

## Appendix: Platform Detection Logic

```python
def detect_platform(remote_url: str) -> str:
    """Detect git platform from remote URL."""
    patterns = {
        "github": [
            r"github\.com[:/]",
            r"github\..*\.com[:/]",  # GitHub Enterprise
        ],
        "gitlab": [
            r"gitlab\.com[:/]",
            r"gitlab\..*\.[a-z]+[:/]",  # Self-hosted GitLab
        ],
        "azure": [
            r"dev\.azure\.com[:/]",
            r".*\.visualstudio\.com[:/]",
        ],
        "bitbucket": [
            r"bitbucket\.org[:/]",
            r"bitbucket\..*\.[a-z]+[:/]",  # Self-hosted
        ],
    }

    for platform, regexes in patterns.items():
        for regex in regexes:
            if re.search(regex, remote_url, re.IGNORECASE):
                return platform

    return "unknown"
```

---

*Report generated: 2026-01-24*
*Review mode: Decision Analysis*
*Reviewer: task-review workflow*
