# Architectural Review Report: TASK-REV-FB13

## Pre-Loop Architecture Regression Analysis

**Review ID**: TASK-REV-FB13
**Review Mode**: Architectural
**Depth**: Comprehensive
**Date**: 2026-01-14
**Reviewer**: Claude (automated architectural review)
**Status**: COMPLETE - Decision Required

---

## Executive Summary

**Finding**: TASK-FB-FIX-015 introduced an **architectural regression** by disabling pre-loop by default for feature-build, breaking the design-first workflow that the Player-Coach loop depends on.

**Root Cause**: The change conflated two distinct concepts:
1. **Feature-plan output**: High-level acceptance criteria and task breakdown
2. **Implementation plan**: Detailed file list, LOC estimates, test strategy from `--design-only`

**Recommendation**: **Option B (Design-First Workflow)** - Feature-build should explicitly execute `--design-only` then `--implement-only`, aligning with the user's original architectural intent.

---

## Architecture Assessment Scores

| Principle | Score | Notes |
|-----------|-------|-------|
| **Single Responsibility** | 65/100 | Pre-loop conflates "skip for well-defined tasks" with "skip plan generation" |
| **Open/Closed** | 70/100 | Extension points exist (enable_pre_loop flag) but default creates coupling |
| **Liskov Substitution** | 80/100 | Feature-build and task-build have different contracts but share code |
| **Interface Segregation** | 75/100 | Pre-loop result interface is well-defined |
| **Dependency Inversion** | 60/100 | Player-Coach loop has hard dependency on pre_loop_result.get("plan") |

**Overall SOLID Score**: 70/100 (Below threshold of 75)

| Principle | Score | Notes |
|-----------|-------|-------|
| **DRY** | 85/100 | Good code reuse via task-work delegation |
| **YAGNI** | 70/100 | Dynamic max_turns feature unused when pre-loop disabled |

---

## Critical Findings

### Finding 1: Architectural Regression Confirmed

**Evidence from Code** (`autobuild.py:538`):
```python
implementation_plan=pre_loop_result.get("plan") if pre_loop_result else None,
```

The `_loop_phase` receives `implementation_plan=None` when pre-loop is disabled. This breaks the Player agent's ability to follow a structured implementation approach.

**Evidence from Error**:
```
QualityGateBlocked: Design phase did not return plan path
```

This error occurs because:
1. `enable_pre_loop=False` (from FIX-015)
2. System still attempts to extract plan path from non-existent output
3. Regex pattern in FIX-019 cannot match output that was never generated

### Finding 2: Dynamic Max-Turns Lost

**Evidence from Code** (`autobuild.py:501-509`):
```python
dynamic_max_turns = pre_loop_result.get("max_turns", self.max_turns)
if dynamic_max_turns != self.max_turns:
    logger.info(
        f"Updating max_turns from {self.max_turns} to {dynamic_max_turns} "
        f"(based on complexity {pre_loop_result.get('complexity')})"
    )
    self.max_turns = dynamic_max_turns
```

When pre-loop is disabled:
- `pre_loop_result` is `None` or empty
- System uses static `max_turns=5` for all tasks
- Complexity-based turn limits (3/5/7) are bypassed

**Impact**: Simple tasks may have too many turns (inefficient), complex tasks may have too few (incomplete).

### Finding 3: Feature-Plan vs Implementation-Plan Confusion

**TASK-FB-FIX-015 Rationale** (from completed task):
> "Feature tasks from `/feature-plan` already have detailed specs, so pre-loop duplicates work."

**User's Counter-Argument** (validated by code analysis):
- **Feature-plan output**: Task breakdown with acceptance criteria
- **Implementation plan**: Detailed technical plan from Phase 2:
  - File list with expected changes
  - LOC estimates per file
  - Test strategy and coverage targets
  - Architectural approach

These are **not equivalent**. The implementation plan is generated by `task-work --design-only` (Phases 2-2.8) and provides the Player with concrete technical guidance.

### Finding 4: Prior Reviews Did Not Recommend This Approach

**TASK-REV-FB11** recommended:
> "Skip pre-loop for **well-defined** feature-build tasks"

This was interpreted as "skip pre-loop by default", but the qualifier "well-defined" was lost. Not all feature tasks are well-defined.

**TASK-REV-FE8A** found:
> "FB-FIX-015, 016, 017 were NOT implemented"

This indicates the fixes were pending, not that they were correct.

**TASK-REV-FB12** identified:
> "Regex pattern issues for plan path extraction"

FIX-019 addressed this, but the underlying issue (no plan being generated) remains.

---

## Decision Matrix

| Option | Description | Pros | Cons | Risk |
|--------|-------------|------|------|------|
| **A. Revert FIX-015** | Re-enable pre-loop for feature-build | Quick fix, restores functionality | Adds 60-90 min per task, some tasks don't need it | Low |
| **B. Design-First Workflow** | Feature-build calls `--design-only` then `--implement-only` | Aligns with user intent, explicit flow, proper plan generation | Requires implementation changes | Medium |
| **C. Conditional Pre-Loop** | Enable pre-loop only when task lacks implementation_notes | Intelligent gating, best of both worlds | Complex logic, edge cases | Medium |
| **D. No Plan Needed** | Modify Player to work without implementation plan | Simplifies architecture | Reduces quality, Player loses guidance | High |

---

## Recommendation: Option B (Design-First Workflow)

### Rationale

1. **Aligns with User's Original Intent**: The user explicitly stated this was the intended architecture
2. **Explicit Over Implicit**: Clear separation of design and implementation phases
3. **Preserves Quality Gates**: Full Phase 2-2.8 execution with architectural review
4. **Dynamic Max-Turns**: Complexity-based turn limits restored
5. **SOLID Compliance**: Single responsibility - pre-loop does design, loop does implementation

### Implementation Approach

```
/feature-build TASK-XXX
  │
  ├── Phase 1: Setup (worktree creation)
  │
  ├── Phase 2: Design Phase
  │   └── Invoke: task-work TASK-XXX --design-only --auto-approve-checkpoint
  │       ├── Phase 1.6: Clarification (if complexity >= 3)
  │       ├── Phase 2: Implementation Planning
  │       ├── Phase 2.5: Architectural Review
  │       ├── Phase 2.7: Complexity Evaluation
  │       └── Phase 2.8: Auto-approved Checkpoint
  │       → Returns: implementation_plan, complexity, max_turns, architectural_score
  │
  ├── Phase 3: Player-Coach Loop
  │   └── Player invokes: task-work TASK-XXX --implement-only --mode={tdd|standard}
  │       ├── Phase 3: Implementation (with plan context)
  │       ├── Phase 4: Testing
  │       ├── Phase 4.5: Test Enforcement Loop
  │       └── Phase 5: Code Review
  │   └── Coach validates independently
  │
  └── Phase 4: Finalize (preserve worktree)
```

### Key Changes Required

1. **Remove `enable_pre_loop` toggle for feature-build**: Always execute design phase
2. **Update `_pre_loop_phase`**: Explicitly call `--design-only` with `--auto-approve-checkpoint`
3. **Update `_loop_phase` Player invocation**: Call `--implement-only` instead of full task-work
4. **Pass plan path explicitly**: From design phase output to implementation phase

### Backward Compatibility

- **Task-build** (`guardkit autobuild task`): Unchanged, continues to use pre-loop
- **Feature-build** (`guardkit autobuild feature`): Now always generates implementation plan
- **CLI flags**: `--no-pre-loop` removed (no longer applicable to design-first workflow)

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Design phase adds time | High | Medium | Accept trade-off; quality over speed |
| Auto-approve may miss issues | Low | Medium | Coach validation catches issues in loop |
| Complex tasks may need human checkpoint | Medium | Low | Add `--require-checkpoint` flag for manual review |
| Existing automation breaks | Low | Low | Feature-build invocations remain same |

---

## Test Plan

### Unit Tests

1. `test_feature_build_generates_implementation_plan`: Verify design phase produces plan
2. `test_player_receives_implementation_plan`: Verify plan passed to loop phase
3. `test_dynamic_max_turns_from_complexity`: Verify complexity-based turn limits
4. `test_architectural_score_captured`: Verify Phase 2.5 results stored

### Integration Tests

1. `test_feature_build_design_first_workflow`: Full feature-build with design phase
2. `test_implementation_plan_path_extraction`: Verify regex patterns work
3. `test_auto_approve_checkpoint_sdk_mode`: Verify SDK mode bypasses human checkpoint

### Manual Verification

```bash
# Test feature-build with design-first workflow
guardkit autobuild feature FEAT-TEST --sdk-timeout 900 --verbose

# Verify output includes:
# - "Created implementation plan:" message
# - Dynamic max_turns based on complexity
# - Plan context in Player prompt
```

---

## Conclusion

**TASK-FB-FIX-015 introduced an architectural regression** by conflating feature-plan output with implementation plans and disabling the design phase that generates the latter.

The recommended fix is to implement a **design-first workflow** where feature-build explicitly executes:
1. `task-work --design-only` to generate implementation plan
2. `task-work --implement-only` in the Player-Coach loop

This aligns with the user's original architectural intent, preserves all quality gates, and ensures the Player has proper technical guidance.

---

## Decision Checkpoint

**Action Required**: Select one of the following:

- **[A] Accept**: Approve this analysis and recommendation
- **[R] Revise**: Request deeper analysis or different focus
- **[I] Implement**: Create implementation task based on Option B recommendation
- **[C] Cancel**: Discard this review

---

## References

- [TASK-FB-FIX-015](../tasks/completed/TASK-FB-FIX-015/TASK-FB-FIX-015.md) - Pre-loop default change
- [TASK-FB-FIX-019](../tasks/completed/TASK-FB-FIX-019/) - Plan path extraction fix
- [TASK-REV-FB11](./TASK-REV-FB11-review-report.md) - Post-fix timeout analysis
- [TASK-REV-FB12](./TASK-REV-FB12-review-report.md) - Implementation plan gap analysis
- [autobuild.py](../guardkit/orchestrator/autobuild.py) - AutoBuild orchestrator
- [feature-build.md](../installer/core/commands/feature-build.md) - Command specification
