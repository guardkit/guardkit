---
autobuild_state:
  base_branch: main
  current_turn: 1
  last_updated: '2026-02-09T12:21:00.009465'
  max_turns: 25
  started_at: '2026-02-09T12:10:32.867475'
  turns:
  - coach_success: true
    decision: approve
    feedback: null
    player_success: true
    player_summary: Implementation via task-work delegation
    timestamp: '2026-02-09T12:10:32.867475'
    turn: 1
  worktree_path: /Users/richardwoollcott/Projects/appmilla_github/guardkit/.guardkit/worktrees/FEAT-6EDD
complexity: 5
dependencies:
- TASK-SP-001
feature_id: FEAT-SP-001
id: TASK-SP-005
implementation_mode: task-work
parent_review: TASK-REV-DBBC
status: in_review
tags:
- system-plan
- templates
- markdown
- jinja2
task_type: feature
title: Implement architecture markdown writer with Jinja2 templates
wave: 2
implementation_completed: '2026-02-09T15:30:00Z'
quality_gates:
  compilation: passed
  tests_passed: 34/34
  line_coverage: 100%
  branch_coverage: 100%
  code_review_score: 88/100
  code_review_status: APPROVED_WITH_RECOMMENDATIONS
---

# Task: Implement Architecture Markdown Writer with Jinja2 Templates

## Description

Create the markdown output generation layer that produces architecture documentation files from entity data. Uses Jinja2 templates for rendering and handles methodology-aware content (DDD vs modular).

## Acceptance Criteria

- [x] `ArchitectureWriter` class with `write_all(output_dir, system, components, concerns, decisions)` method
- [x] Jinja2 template: `system-context.md.j2` — C4 Level 1 system context with mermaid diagram
- [x] Jinja2 template: `components.md.j2` — Component/bounded context map (adapts to methodology)
- [x] Jinja2 template: `crosscutting.md.j2` — Cross-cutting concerns document
- [x] Jinja2 template: `adr.md.j2` — Individual ADR in Michael Nygard format
- [x] Jinja2 template: `architecture-index.md.j2` — ARCHITECTURE.md index linking all docs
- [x] Output filename adapts: `bounded-contexts.md` for DDD, `components.md` otherwise
- [x] Mermaid diagrams generated for system context and component map
- [x] DDD sections (aggregate roots, domain events, context mapping) only in DDD methodology
- [x] ADR files written to `docs/architecture/decisions/` subdirectory
- [x] `docs/architecture/` directory created if not exists
- [x] All output files have "Generated by /system-plan" header with date
- [x] Unit tests: template rendering produces valid markdown
- [x] Unit tests: DDD vs non-DDD content differences verified

## Files Created

- `guardkit/planning/architecture_writer.py` — ArchitectureWriter class (203 lines)
- `guardkit/templates/system-context.md.j2` — System context template (51 lines)
- `guardkit/templates/components.md.j2` — Component map template (81 lines)
- `guardkit/templates/crosscutting.md.j2` — Crosscutting concerns template (29 lines)
- `guardkit/templates/adr.md.j2` — ADR template (27 lines)
- `guardkit/templates/architecture-index.md.j2` — Index template (50 lines)
- `tests/unit/planning/test_architecture_writer.py` — Unit tests (986 lines, 34 tests)

## Implementation Notes

- Jinja2 is already a dependency (used in `installer/core/commands/lib/templates/`)
- Template loading: use `jinja2.Environment(loader=PackageLoader("guardkit", "templates"))` or FileSystemLoader
- Mermaid syntax: `graph TB` for system context, `graph LR` for component map
- Follow spec templates in "Output Artefacts" section exactly
- Handle empty lists gracefully (no empty sections in output)
- `write_all()` should be synchronous (file I/O only, no Graphiti calls)

## Seam Test Points

- Templates render without Jinja2 errors for all entity combinations
- DDD entities produce `bounded-contexts.md`, modular entities produce `components.md`
- Generated markdown is valid (no unclosed tags, correct mermaid syntax)
- Empty entity lists don't produce broken output

## Implementation Summary

### TDD Workflow Completed

1. **RED Phase**: Created 34 comprehensive failing tests first
2. **GREEN Phase**: Implemented ArchitectureWriter class and 5 Jinja2 templates
3. **REFACTOR Phase**: Code review with minor recommendations

### Quality Gates Passed

| Gate | Target | Actual | Status |
|------|--------|--------|--------|
| Compilation | 100% | 100% | ✅ PASS |
| Tests Pass | 100% | 100% (34/34) | ✅ PASS |
| Line Coverage | ≥80% | 100% | ✅ EXCEEDS |
| Branch Coverage | ≥75% | 100% | ✅ EXCEEDS |
| Code Review | ≥60/100 | 88/100 | ✅ PASS |

### Code Review Recommendations (Non-Blocking)

1. **Error handling**: Add try/except for file I/O operations
2. **Input validation**: Validate parameters before processing
3. **Logging**: Add module-level logger for debugging

These are minor improvements that can be addressed in a follow-up task.
