---
id: TASK-REV-YAML
title: Review and fix Feature YAML schema contract enforcement
status: review_complete
task_type: review
review_mode: code-quality
review_depth: standard
created: 2026-02-14T00:00:00Z
priority: high
tags: [feature-yaml, schema, feature-loader, feature-plan, system-plan, recurring-bug]
complexity: 6
decision_required: true
---

# Task: Review and fix Feature YAML schema contract enforcement

## Problem Statement

Feature YAML files generated by commands (`/feature-plan`, `/system-plan`, manual creation) repeatedly fail `FeatureLoader` validation because there is no single source of truth for the schema. The same class of bug has occurred at least twice:

1. **TASK-REV-66B4** (Jan 2026): `/feature-plan` generated `execution_groups` instead of `orchestration.parallel_groups`, missing `file_path` and `status` fields. All 5 fix tasks were completed.
2. **FEAT-AC1A** (Feb 2026): `/system-plan` review generated `parallel_groups` at top level instead of nested under `orchestration:`, used `status: backlog` instead of `status: pending`, included extra fields (`task_type`, `source`, `architecture_review`) that are silently ignored.

Despite TASK-REV-66B4 being fully remediated, the root cause persists: the schema contract is implicit, encoded only in `FeatureLoader._parse_feature()` and `_parse_task()` Python code, with no schema validation at generation time.

## Root Cause Analysis

### Why this keeps happening

1. **No shared schema definition**: The FeatureLoader expects specific field names and nesting (`orchestration.parallel_groups`, `status: pending`), but this is only discoverable by reading the Python code. Command specs, AI prompts, and manual creation don't reference a canonical schema.

2. **Multiple generation paths**: Feature YAMLs are created by at least 4 paths:
   - `/feature-plan` command spec (fixed in TASK-FP-002)
   - `/system-plan` → review mode → chain to feature plan (NOT fixed)
   - Manual creation by AI (following examples or command spec)
   - `FeatureLoader.save_feature()` (always correct — round-trip)

3. **Silent acceptance of invalid fields**: The loader uses `.get()` with defaults for most fields, so extra/wrong fields are silently ignored. Only missing required fields (`id`, `file_path`) and validation logic (`Tasks not in orchestration`) surface errors — and they surface at runtime, not at generation time.

4. **No validation at write time**: When a YAML is generated, there's no `FeatureLoader.validate_yaml(data)` call to catch mismatches before the file is written.

5. **FeatureTask Literal type not enforced at YAML level**: The dataclass uses `Literal["pending", "in_progress", "completed", "failed", "skipped"]` but YAML parsing via `yaml.safe_load()` returns raw strings — no type checking occurs, so `status: backlog` loads fine but fails validation later.

## Specific Schema Mismatches Found (FEAT-AC1A)

| Field | Generated | Expected by FeatureLoader | Impact |
|-------|-----------|--------------------------|--------|
| `parallel_groups` | Top-level key | Nested under `orchestration:` | Waves: 0, all tasks unorchestrated |
| `status` (task) | `backlog` | `pending` | Accepted silently (no Literal check at parse) |
| `task_type` (task) | Present | Not in schema | Silently ignored (extra field) |
| `source` | Present | Not in schema | Silently ignored |
| `architecture_review` | Present | Not in schema | Silently ignored |

## Files to Review

| File | Role | Issue |
|------|------|-------|
| `guardkit/orchestrator/feature_loader.py` | Schema consumer | Implicit schema, silent acceptance of extras |
| `installer/core/commands/feature-plan.md` | Primary generator | Fixed in TASK-FP-002, but examples not canonical |
| `installer/core/commands/system-plan.md` | Secondary generator | No reference to feature YAML schema at all |
| `guardkit/models/task_types.py` | TaskType/status enums | Not shared with YAML validation |
| `tests/unit/test_feature_loader.py` | Schema tests | May not cover all edge cases |

## Questions to Answer

1. **Should there be a canonical schema file?** (e.g., JSON Schema, Pydantic model, or documented YAML in a shared location that all generators reference)
2. **Should FeatureLoader validate at parse time?** (reject unknown status values, warn on extra fields)
3. **Should there be a `guardkit feature validate FEAT-XXX` CLI command?** (pre-flight check before `autobuild feature`)
4. **Should all command specs that generate feature YAMLs include the canonical schema inline?**
5. **Should `FeatureLoader._parse_task()` reject invalid `status` values** instead of silently accepting them?

## Recommended Review Scope

### Primary investigation
- Map all code paths that generate Feature YAML files
- Compare each generator's output against `FeatureLoader._parse_feature()` expectations
- Identify which fields are required vs optional vs silently ignored

### Secondary investigation
- Review TASK-REV-66B4 fix tasks to understand what was fixed and what was missed
- Check if `FeatureLoader.save_feature()` output can serve as the canonical schema reference
- Evaluate whether Pydantic validation (already used elsewhere in GuardKit) should replace dataclass parsing

## Acceptance Criteria

- [ ] All feature YAML generation paths identified and documented
- [ ] Schema mismatches between each generator and FeatureLoader catalogued
- [ ] Root cause confirmed (no canonical schema, no write-time validation)
- [ ] Recommended fix approach identified (schema file, validation command, or both)
- [ ] Implementation tasks created if [I]mplement chosen

## Prior Art

- **TASK-REV-66B4**: Previous review of same issue class (completed, fix was partial)
- **FEAT-AC1A error**: `Tasks not in orchestration` — all 11 tasks unorchestrated due to `parallel_groups` at wrong nesting level
- **Seam S3 in testing strategy**: This is exactly the kind of orchestrator→module wiring bug that seam tests are designed to catch

## Review Mode

Suggested: `--mode=code-quality --depth=standard`
