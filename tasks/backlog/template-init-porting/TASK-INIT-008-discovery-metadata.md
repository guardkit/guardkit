---
id: TASK-INIT-008
title: "Port discovery metadata to /template-init agents"
status: backlog
created: 2025-11-26T07:30:00Z
updated: 2025-11-26T07:30:00Z
priority: medium
tags: [template-init, agents, discovery, week4, discovery-automation]
complexity: 4
estimated_hours: 4
parent_review: TASK-5E55
week: 4
phase: discovery-automation
related_tasks: [TASK-INIT-001]
dependencies: [TASK-INIT-001]
test_results:
  status: pending
  coverage: null
  last_run: null
---

# Task: Port Discovery Metadata to /template-init Agents

## Problem Statement

Agents generated by `/template-init` lack discovery metadata (stack, phase, capabilities, keywords), missing Critical Gap #11 from TASK-5E55. AI-powered agent discovery cannot match tasks to greenfield template agents.

**Impact**: Agent discovery system falls back to generic task-manager instead of using specialized agents, reducing implementation quality and speed.

## Analysis Findings

From TASK-5E55 review:
- `/template-create` adds frontmatter metadata to all agents
- Metadata includes: stack, phase, capabilities, keywords
- Enables intelligent agent discovery during /task-work
- `/template-init` generates agents without frontmatter
- Gap severity: ğŸŸ´ **HIGH** (impacts agent discoverability)

**Current State**: Agents without discovery metadata

**Desired State**: All agents include frontmatter derived from Q&A answers

## Recommended Fix

**Approach**: Add frontmatter generation to agent creation, mapping Q&A answers to metadata fields.

**Strategy**:
- **MINIMAL SCOPE**: Add frontmatter without changing agent content
- **Q&A MAPPING**: Derive metadata from session answers (language, framework, etc.)
- **FRONTMATTER FORMAT**: Match template-create format for consistency
- **AGENT TYPES**: Technology-specific metadata for each agent type

## Code Changes Required

### File: installer/global/commands/lib/greenfield_qa_session.py

**ADD metadata generation method** (after line 680):

```python
def _generate_agent_metadata(self, agent_type: str) -> dict:
    """
    Generate discovery metadata for agent.

    Port of template-create agent metadata generation.

    Args:
        agent_type: Type of agent (testing, repository, api, etc.)

    Returns:
        dict with stack, phase, capabilities, keywords

    Example:
        >>> session._session_data = {'primary_language': 'python', 'framework': 'fastapi'}
        >>> metadata = session._generate_agent_metadata('api')
        >>> metadata['stack']
        ['python', 'fastapi']
    """
    # Base metadata from Q&A
    language = self._session_data.get('primary_language', 'unknown').lower()
    framework = self._session_data.get('framework', '').lower()

    # Build stack list
    stack = [language]
    if framework:
        stack.append(framework)

    # Agent-type specific metadata
    capabilities = []
    keywords = []

    if agent_type == 'testing':
        capabilities = [
            'test-execution',
            'coverage-verification',
            'build-validation',
            'quality-gates'
        ]
        keywords = ['testing', 'quality', 'verification', 'tdd']

    elif agent_type == 'repository':
        capabilities = [
            'data-access',
            'orm-patterns',
            'query-optimization',
            'transaction-management'
        ]
        keywords = ['repository', 'data', 'persistence', 'database']

    elif agent_type == 'api':
        capabilities = [
            'endpoint-implementation',
            'request-validation',
            'response-formatting',
            'error-handling'
        ]
        keywords = ['api', 'endpoints', 'rest', 'http']

    elif agent_type == 'domain':
        capabilities = [
            'business-logic',
            'domain-modeling',
            'value-objects',
            'aggregates'
        ]
        keywords = ['domain', 'business-logic', 'ddd', 'modeling']

    elif agent_type == 'service':
        capabilities = [
            'business-orchestration',
            'workflow-coordination',
            'validation',
            'error-handling'
        ]
        keywords = ['service', 'business-logic', 'orchestration']

    else:
        # Generic agent
        capabilities = ['implementation', 'code-generation']
        keywords = [agent_type, language]

    # Add technology-specific keywords
    keywords.extend([language, framework]) if framework else keywords.append(language)

    return {
        'stack': stack,
        'phase': 'implementation',  # Greenfield agents are for implementation
        'capabilities': capabilities,
        'keywords': keywords
    }


def _format_agent_with_metadata(self, agent_content: str, metadata: dict) -> str:
    """
    Add frontmatter to agent markdown.

    Args:
        agent_content: Raw agent markdown content
        metadata: Discovery metadata dict

    Returns:
        Agent content with frontmatter

    Example:
        >>> content = "# Test Agent\\n\\nAgent content"
        >>> metadata = {'stack': ['python'], 'phase': 'implementation'}
        >>> formatted = session._format_agent_with_metadata(content, metadata)
        >>> '---' in formatted
        True
    """
    # Format stack as YAML array
    stack_yaml = ', '.join(metadata['stack']) if metadata['stack'] else ''

    # Format capabilities as YAML array
    capabilities_yaml = ', '.join(f'"{cap}"' for cap in metadata['capabilities'])

    # Format keywords as YAML array
    keywords_yaml = ', '.join(f'"{kw}"' for kw in metadata['keywords'])

    frontmatter = f"""---
stack: [{stack_yaml}]
phase: {metadata['phase']}
capabilities: [{capabilities_yaml}]
keywords: [{keywords_yaml}]
---

"""

    return frontmatter + agent_content
```

**MODIFY _generate_agent() method** (around line 750):

```python
def _generate_agent(self, agent_type: str) -> str:
    """
    Generate agent with boundary sections and discovery metadata.

    NOW INCLUDES frontmatter metadata for agent discovery.
    """
    technology = self._session_data.get('primary_language', 'unknown')

    # Generate boundary sections (from TASK-INIT-001)
    boundaries = generate_boundary_sections(agent_type, technology)

    # Validate boundaries
    is_valid, errors = validate_boundary_sections(boundaries)
    if not is_valid:
        print(f"âš ï¸ Boundary validation warnings for {agent_type}:")
        for error in errors:
            print(f"   - {error}")

    # Generate base agent content
    agent_content = self._generate_base_agent_content(agent_type)

    # Insert boundaries after Quick Start
    # ... existing boundary insertion logic ...

    # Generate discovery metadata
    metadata = self._generate_agent_metadata(agent_type)

    # Add frontmatter
    agent_with_metadata = self._format_agent_with_metadata(agent_content, metadata)

    return agent_with_metadata
```

## Scope Constraints

### âŒ DO NOT
- Modify agent content beyond adding frontmatter
- Change Q&A workflow to collect more metadata
- Add complex metadata inference logic
- Modify agent discovery system
- Change frontmatter format

### âœ… DO ONLY
- Add frontmatter to generated agents
- Map Q&A answers to metadata fields
- Use agent-type specific capabilities/keywords
- Match template-create frontmatter format
- Keep metadata generation simple

## Files to Modify

1. **installer/global/commands/lib/greenfield_qa_session.py** - ADD
   - `_generate_agent_metadata()` method (~80 lines)
   - `_format_agent_with_metadata()` method (~25 lines)

2. **installer/global/commands/lib/greenfield_qa_session.py** - MODIFY
   - `_generate_agent()` method to add metadata (~10 lines)

## Files to NOT Touch

- Agent discovery system (installer/global/agents/)
- Agent content templates
- Q&A workflow
- Boundary sections logic (TASK-INIT-001)

## Testing Requirements

### Unit Tests

```python
def test_generate_agent_metadata_python_api():
    """Test metadata generation for Python API agent."""
    session = TemplateInitQASession()
    session._session_data = {
        'primary_language': 'python',
        'framework': 'fastapi'
    }

    metadata = session._generate_agent_metadata('api')

    assert metadata['stack'] == ['python', 'fastapi']
    assert metadata['phase'] == 'implementation'
    assert 'endpoint-implementation' in metadata['capabilities']
    assert 'api' in metadata['keywords']

def test_generate_agent_metadata_typescript_testing():
    """Test metadata generation for TypeScript testing agent."""
    session = TemplateInitQASession()
    session._session_data = {
        'primary_language': 'typescript',
        'framework': 'react'
    }

    metadata = session._generate_agent_metadata('testing')

    assert metadata['stack'] == ['typescript', 'react']
    assert 'test-execution' in metadata['capabilities']
    assert 'testing' in metadata['keywords']

def test_format_agent_with_metadata():
    """Test frontmatter formatting."""
    session = TemplateInitQASession()

    content = "# Test Agent\n\nAgent content"
    metadata = {
        'stack': ['python', 'fastapi'],
        'phase': 'implementation',
        'capabilities': ['api', 'testing'],
        'keywords': ['python', 'api']
    }

    formatted = session._format_agent_with_metadata(content, metadata)

    assert formatted.startswith('---')
    assert 'stack: [python, fastapi]' in formatted
    assert 'phase: implementation' in formatted
    assert '# Test Agent' in formatted
```

### Integration Tests

```python
def test_generated_agents_include_frontmatter():
    """Test agents have discovery metadata."""
    session = TemplateInitQASession()
    session._session_data = {
        'primary_language': 'python',
        'framework': 'fastapi'
    }

    agent_content = session._generate_agent('api')

    # Check frontmatter present
    assert agent_content.startswith('---')
    assert 'stack:' in agent_content
    assert 'phase:' in agent_content
    assert 'capabilities:' in agent_content
    assert 'keywords:' in agent_content

def test_metadata_matches_template_create_format():
    """Test frontmatter matches template-create format."""
    # Compare with reference template-create agent
    session = TemplateInitQASession()
    session._session_data = {'primary_language': 'python'}

    metadata = session._generate_agent_metadata('testing')

    # Should have same fields as template-create
    assert 'stack' in metadata
    assert 'phase' in metadata
    assert 'capabilities' in metadata
    assert 'keywords' in metadata
```

## Acceptance Criteria

- [ ] All generated agents include frontmatter
- [ ] Frontmatter has stack, phase, capabilities, keywords fields
- [ ] Stack derived from primary_language and framework Q&A
- [ ] Phase set to 'implementation' for all agents
- [ ] Capabilities agent-type specific
- [ ] Keywords include technology and agent type
- [ ] Format matches template-create agents
- [ ] Agent discovery system can find greenfield agents
- [ ] Agents still valid markdown

## Estimated Effort

**4 hours** broken down as:
- Study template-create agent metadata (30 minutes)
- Implement metadata generation (1.5 hours)
- Implement frontmatter formatting (1 hour)
- Integrate into agent generation (30 minutes)
- Testing (30 minutes)

## Dependencies

**TASK-INIT-001** - Boundary sections must be in place first

## Risk Assessment

### Risks

| Risk | Probability | Impact | Severity |
|------|------------|--------|----------|
| Metadata mapping incomplete | Medium | Low | ğŸŸ¡ Low |
| Frontmatter breaks markdown | Low | Low | ğŸŸ¢ Minimal |
| Agent discovery doesn't match | Low | Medium | ğŸŸ¡ Low |

### Mitigation Strategies

1. **Metadata mapping**: Start with core agent types (testing, api, repository, domain, service), expand later
2. **Markdown compatibility**: Use standard YAML frontmatter format
3. **Discovery matching**: Test with agent discovery system, verify matching works

## References

- **Parent Review**: TASK-5E55
- **Agent Discovery**: docs/guides/agent-discovery-guide.md
- **Related Task**: TASK-INIT-001 (boundary sections)
- **Example Agents**: installer/global/templates/*/agents/*.md

## Success Metrics

When complete:
- âœ… 100% of generated agents have frontmatter
- âœ… Agent discovery finds greenfield template agents
- âœ… Metadata derived from Q&A answers
- âœ… Format matches template-create agents
- âœ… No breaking changes to agent content
