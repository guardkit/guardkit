# Implementation Guide: Template-Init Rules Structure

## Execution Strategy

This guide breaks the implementation into three waves, identifying which tasks require `/task-work` (full quality gates) vs direct implementation, and which can run in parallel using Conductor workspaces.

---

## Wave 1: Foundation (Sequential)

### Prerequisites
- None (starting point)

### Tasks

#### TASK-TI-001: Add Rules Structure Flags
- **Method**: Direct (Claude Code)
- **Complexity**: 3/10
- **Workspace**: Main branch
- **Estimated Time**: 1-2 hours

**Why Direct?**
- Documentation-only change to command specification
- No Python code changes required in this task
- Low risk, straightforward edits

**What to Do:**
1. Edit `installer/core/commands/template-init.md`
2. Add flag documentation to Options table
3. Add flag descriptions matching `/template-create`
4. Update examples section

### Wave 1 Completion Criteria
- [x] `--use-rules-structure` flag documented (default: true)
- [x] `--no-rules-structure` flag documented
- [x] `--claude-md-size-limit` flag documented
- [x] Examples updated to show flag usage

---

## Wave 2: Core Implementation (Parallel)

### Prerequisites
- Wave 1 complete (flags documented)

### Parallel Execution

These two tasks can run simultaneously in separate Conductor workspaces:

```
Wave 2 Parallel Tasks:
├── Workspace: template-init-rules-wave2-1
│   └── TASK-TI-002: Rules structure generation
└── Workspace: template-init-rules-wave2-2
    └── TASK-TI-003: Agent split files
```

**No file conflicts**: TI-002 modifies rules generation code, TI-003 modifies agent generation code.

---

#### TASK-TI-002: Generate Rules Structure in template-init
- **Method**: /task-work (TDD recommended)
- **Complexity**: 6/10
- **Workspace**: `template-init-rules-wave2-1`
- **Estimated Time**: 3-4 hours

**Why /task-work?**
- New Python code for rules structure generation
- Requires architectural review (Phase 2.5)
- Needs test coverage (Phase 4.5)
- Moderate complexity with multiple file changes

**Implementation Steps:**
1. Add new phase (Phase 4.5) for rules structure generation
2. Create rules generator module based on Q&A answers
3. Generate code-style.md based on language selection
4. Generate testing.md based on framework selection
5. Generate patterns/ files based on architecture pattern
6. Respect `--no-rules-structure` flag
7. Add unit tests for generator

**Files to Modify:**
- `installer/core/commands/lib/template_init_orchestrator.py` (or equivalent)
- New: `installer/core/lib/rules_generator/` module
- Tests: `tests/unit/test_rules_generator.py`

**Testing Strategy:**
- Unit tests for each rule file generator
- Integration test for full rules structure
- Verify path patterns are correctly generated

---

#### TASK-TI-003: Generate Agent Split Files
- **Method**: /task-work (TDD recommended)
- **Complexity**: 5/10
- **Workspace**: `template-init-rules-wave2-2`
- **Estimated Time**: 2-3 hours

**Why /task-work?**
- Modifies agent generation logic
- Requires splitting algorithm
- Needs test coverage
- Affects template output structure

**Implementation Steps:**
1. Modify agent generation (Phase 3) to split output
2. Implement content splitting logic:
   - Core file: boundaries, capabilities, quick start (~6-10KB)
   - Extended file: detailed examples, best practices (~15-25KB)
3. Add size validation (warn if core >15KB)
4. Update output structure in save phase
5. Add unit tests

**Files to Modify:**
- `installer/core/lib/agent_generator/agent_generator.py`
- New: `installer/core/lib/agent_generator/agent_splitter.py`
- Tests: `tests/unit/test_agent_splitter.py`

**Testing Strategy:**
- Unit tests for split algorithm
- Verify size targets met
- Verify content correctly divided

---

### Wave 2 Completion Criteria
- [ ] Rules structure generated by default
- [ ] `--no-rules-structure` flag suppresses generation
- [ ] Agent files split into `*.md` and `*-ext.md`
- [ ] Size targets validated
- [ ] All tests pass

---

## Wave 3: Polish (Parallel)

### Prerequisites
- Wave 2 complete (core implementation done)

### Parallel Execution

These two tasks can run simultaneously:

```
Wave 3 Parallel Tasks:
├── Workspace: template-init-rules-wave3-1
│   └── TASK-TI-004: Documentation updates
└── Workspace: template-init-rules-wave3-2
    └── TASK-TI-005: Guidance file generation
```

**No file conflicts**: TI-004 is documentation only, TI-005 is code addition.

---

#### TASK-TI-004: Update template-init Documentation
- **Method**: Direct (Claude Code)
- **Complexity**: 3/10
- **Workspace**: `template-init-rules-wave3-1`
- **Estimated Time**: 1-2 hours

**Why Direct?**
- Documentation-only changes
- No code changes
- Low risk

**Implementation Steps:**
1. Update output structure diagram to show `.claude/rules/`
2. Add "Rules Structure" section matching `/template-create`
3. Update feature comparison table
4. Add examples showing rules structure output
5. Update phase descriptions

**Files to Modify:**
- `installer/core/commands/template-init.md`

---

#### TASK-TI-005: Generate Guidance Files from Agents
- **Method**: /task-work
- **Complexity**: 5/10
- **Workspace**: `template-init-rules-wave3-2`
- **Estimated Time**: 2-3 hours

**Why /task-work?**
- New code for guidance extraction
- Requires content transformation logic
- Needs test coverage

**Implementation Steps:**
1. Create guidance generator that extracts from agent files:
   - Extract boundaries (ALWAYS/NEVER/ASK)
   - Create brief capability summary
   - Add reference to full agent
2. Generate path patterns based on agent stack/phase
3. Save to `.claude/rules/guidance/`
4. Validate size (<3KB per guidance file)
5. Add unit tests

**Files to Modify:**
- New: `installer/core/lib/guidance_generator/` module
- Tests: `tests/unit/test_guidance_generator.py`

**Testing Strategy:**
- Unit tests for extraction logic
- Verify size constraints
- Verify path patterns correct

---

### Wave 3 Completion Criteria
- [ ] Documentation fully aligned with `/template-create`
- [ ] Guidance files generated in `.claude/rules/guidance/`
- [ ] All size constraints validated
- [ ] All tests pass

---

## Conductor Workspace Commands

### Wave 2 Setup

```bash
# Create worktrees for parallel Wave 2
conductor worktree add template-init-rules-wave2-1 -b feature/ti-002-rules-structure
conductor worktree add template-init-rules-wave2-2 -b feature/ti-003-agent-split

# In workspace 1:
cd ../template-init-rules-wave2-1
/task-work TASK-TI-002

# In workspace 2:
cd ../template-init-rules-wave2-2
/task-work TASK-TI-003
```

### Wave 3 Setup

```bash
# Create worktrees for parallel Wave 3
conductor worktree add template-init-rules-wave3-1 -b feature/ti-004-docs
conductor worktree add template-init-rules-wave3-2 -b feature/ti-005-guidance

# In workspace 1:
cd ../template-init-rules-wave3-1
# Direct implementation (no /task-work needed)

# In workspace 2:
cd ../template-init-rules-wave3-2
/task-work TASK-TI-005
```

### Merging

```bash
# After Wave 2 completes
git checkout main
git merge feature/ti-002-rules-structure
git merge feature/ti-003-agent-split

# After Wave 3 completes
git merge feature/ti-004-docs
git merge feature/ti-005-guidance

# Cleanup
conductor worktree remove template-init-rules-wave2-1
conductor worktree remove template-init-rules-wave2-2
conductor worktree remove template-init-rules-wave3-1
conductor worktree remove template-init-rules-wave3-2
```

---

## Implementation Method Summary

| Task | Method | Reason |
|------|--------|--------|
| TASK-TI-001 | Direct | Documentation only, low risk |
| TASK-TI-002 | /task-work | New Python code, needs tests, moderate complexity |
| TASK-TI-003 | /task-work | Modifies core logic, needs tests |
| TASK-TI-004 | Direct | Documentation only, low risk |
| TASK-TI-005 | /task-work | New Python code, needs tests |

**Summary**: 3 tasks via `/task-work`, 2 tasks direct

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Breaking existing templates | All changes additive, defaults preserved |
| Wave 2 tasks conflict | Separate code modules, no overlap |
| Wave 3 tasks conflict | Different file types (docs vs code) |
| Merge conflicts | Feature branches, clean separation |

---

## Timeline Estimate

| Phase | Duration | Notes |
|-------|----------|-------|
| Wave 1 | 1-2 hours | Sequential |
| Wave 2 | 3-4 hours | 2 tasks parallel (saves ~2 hours) |
| Wave 3 | 2-3 hours | 2 tasks parallel (saves ~1 hour) |
| Integration | 1 hour | Merging, final testing |
| **Total** | **7-10 hours** | **~30% faster with parallelization** |

Without parallelization: 10-14 hours
With parallelization: 7-10 hours
**Savings**: 3-4 hours (~30%)
