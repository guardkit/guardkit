---
id: TASK-IC-B4E6
title: Refactor docker_fixtures.py to consumer-aware URL generation
status: backlog
created: 2026-02-18T00:00:00Z
updated: 2026-02-18T00:00:00Z
priority: normal
task_type: feature
parent_feature: TASK-FP-1B6D
parent_review: TASK-REV-0E07
complexity: 4
dependencies:
  - TASK-IC-DD44  # Child B must be complete — this refactor is only done after the contract system is proven
related_tasks:
  - TASK-IC-6F94  # Child A (grandparent dependency)
  - TASK-IC-DD44  # Child B (direct prerequisite)
  - TASK-FP-1B6D  # Superseded parent task (do not work on)
tags: [docker-fixtures, consumer-context, autobuild, python-template]
---

# Refactor docker_fixtures.py to Consumer-Aware URL Generation

## Context

This is Child C of the TASK-FP-1B6D decomposition. It is the final layer of defence-in-depth and must only be worked on after TASK-IC-DD44 (Child B) is complete and the integration contract + consumer_context system is proven in production.

**Do not start this task until TASK-IC-DD44 is in COMPLETED status.**

This task refactors `docker_fixtures.py` in the FastAPI/Python stack template so it no longer hardcodes connection URL formats. Instead it accepts a `consumer_context` parameter and adapts URLs accordingly. This means new frameworks require a new consumer context entry in the feature plan, not a code change to the fixtures module.

## Change Required

**File:** The `docker_fixtures.py` fixture module in the FastAPI/Python stack template. Locate it via:

```bash
find installer/core/templates -name "docker_fixtures.py"
# Also check: installer/core/templates/fastapi-python/
```

**Current problem:** `docker_fixtures.py` hardcodes connection URL formats per service (e.g. `postgresql://user:pass@host:port/db`). The correct async format (`postgresql+asyncpg://`) must be known by the fixture module, which is a framework-specific concern that should not live there.

**Target design:**

```python
from typing import Optional, Dict

DOCKER_FIXTURES = {
    "postgresql": {
        "image": "postgres:16",
        "env_export": {
            # Base URL template — scheme overridden by consumer context
            "DATABASE_URL": "postgresql://{user}:{password}@{host}:{port}/{database}"
        },
        "defaults": {
            "user": "postgres", "password": "test",
            "host": "localhost", "port": 5433, "database": "test"
        }
    }
    # Additional services follow same pattern
}

def get_env_exports(
    service: str,
    consumer_context: Optional[Dict] = None
) -> Dict[str, str]:
    """
    Get environment variable exports for a Docker fixture service.

    Args:
        service: Service name (e.g. "postgresql", "redis", "mongodb")
        consumer_context: Optional dict mapping env var keys to format
            adaptation callables. Comes from the integration contract
            generated by /feature-plan. If None, returns base URL format.

    Returns:
        Dict of env var name → value, with URL format adapted for consumer
        if consumer_context is provided.

    Example:
        # Base URL (no consumer context):
        get_env_exports("postgresql")
        # → {"DATABASE_URL": "postgresql://postgres:test@localhost:5433/test"}

        # Consumer-adapted URL:
        ctx = {"DATABASE_URL": AsyncpgUrlAdapter()}
        get_env_exports("postgresql", consumer_context=ctx)
        # → {"DATABASE_URL": "postgresql+asyncpg://postgres:test@localhost:5433/test"}
    """
    fixture = DOCKER_FIXTURES[service]
    exports = {}

    for key, template in fixture["env_export"].items():
        url = template.format(**fixture["defaults"])

        if consumer_context and key in consumer_context:
            url = consumer_context[key].adapt_url(url)

        exports[key] = url

    return exports
```

`docker_fixtures.py` must not import or reference asyncpg, aiomysql, Motor, aioredis, or any other consumer framework. Format specifics live exclusively in the consumer context passed by the caller.

## Acceptance Criteria

- [ ] `get_env_exports(service)` (no consumer_context) returns base URL format unchanged
- [ ] `get_env_exports(service, consumer_context=ctx)` adapts the URL to the format specified by the consumer context
- [ ] `docker_fixtures.py` contains no imports of or references to asyncpg, aiomysql, Motor, aioredis, or any other consumer framework
- [ ] **Concrete verification:**
  - `get_env_exports("postgresql")["DATABASE_URL"]` returns `"postgresql://postgres:test@localhost:5433/test"`
  - `get_env_exports("postgresql", consumer_context={"DATABASE_URL": AsyncpgUrlAdapter()})["DATABASE_URL"]` returns `"postgresql+asyncpg://postgres:test@localhost:5433/test"`
- [ ] The existing `postgresql+asyncpg://` hardcoded value (from TASK-FIX-0C22) is replaced by the consumer-context mechanism — no regressions for projects that use asyncpg
- [ ] Unit tests cover: no consumer_context (base URL), with consumer_context (adapted URL), unknown service (raises KeyError with clear message)
- [ ] All existing call sites of `get_env_exports('postgresql')` in `coach_validator.py` and orchestrator code are updated to pass `consumer_context` when the task metadata has it available — otherwise the TASK-FIX-0C22 immediate fix is regressed

## Constraints

- This task MUST NOT begin until TASK-IC-DD44 is COMPLETED — it is defence-in-depth, not a primary fix
- Do NOT hardcode any framework-specific URL schemes in `DOCKER_FIXTURES` — only base URL templates with `{placeholder}` substitution
- The `consumer_context` parameter is optional — existing callers that don't pass it must continue to work without modification
- Do NOT modify the `DOCKER_FIXTURES` dict structure for services that have not been reviewed — only refactor the URL generation path
- **Backwards-compatibility risk:** The TASK-FIX-0C22 immediate fix hardcoded `postgresql+asyncpg://` into docker_fixtures. This refactor reverts the base URL to `postgresql://` and relies on consumer_context for adaptation. All existing callers must be updated to pass consumer_context, or the original bug is reintroduced. Search for all call sites with `grep -rn 'get_env_exports' guardkit/` and update each one

## Implementation Notes

- The immediate fix (TASK-FIX-0C22) hardcoded `postgresql+asyncpg://` — this task replaces that with the proper consumer-context mechanism
- Locate the file: `find installer/core/templates -name "docker_fixtures.py"`
- See: `docs/reviews/autobuild-fixes/docker-fixtures-deep-analysis.md` §5.4 for the full design rationale
- `AsyncpgUrlAdapter` is an example class name — the exact adapter interface is up to the implementer, as long as it follows the `adapt_url(base_url) -> str` pattern
