---
id: TASK-019A
title: Reorder template-create Phases to Prevent Agent Documentation Mismatch
status: completed
priority: high
type: bug-fix-architecture
complexity: 6
created: 2025-01-07
completed: 2025-11-07T00:00:00Z
duration: 1 hour
estimated_hours: 4-6
actual_hours: 1
related: TASK-018
epic: EPIC-001
location: tasks/completed/TASK-019A/
organized_files:
  - TASK-019A.md
  - test-verification-report.md
  - completion-report.md
quality_metrics:
  tests_passed: 89/89
  test_pass_rate: 100%
  code_quality_score: 8.7/10
  architecture_score: 88/100
  critical_issues: 0
  major_issues: 0
  minor_issues: 3
---

# TASK-019A: Reorder template-create Phases to Prevent Agent Documentation Mismatch

**Priority**: High
**Type**: Bug Fix / Architecture Improvement
**Related**: TASK-018 (Investigation)
**Epic**: EPIC-001 (AI Template Creation)
**Created**: 2025-01-07
**Status**: ‚úÖ COMPLETED (2025-11-07)
**Complexity**: 6/10 (Medium)

## Problem Statement

The `/template-create` command has a **phase ordering issue** that causes CLAUDE.md to document agents that don't exist yet, leading to hallucinations and documentation inaccuracies.

### Current Problematic Order
```
Phase 1: Q&A Session
Phase 2: AI Analysis
Phase 3: Manifest Generation
Phase 4: Settings Generation
Phase 5: CLAUDE.md Generation     ‚Üê Documents agents before they exist
Phase 6: Template File Generation
Phase 7: Agent Recommendation      ‚Üê Creates actual agents
Phase 8: Package Assembly
```

**The Issue**: Phase 5 generates "Agent Usage Guidelines" in CLAUDE.md before Phase 7 creates the agents, causing:
- ‚ùå AI hallucination (documents non-existent agents like `clean-architecture-specialist`)
- ‚ùå Mismatch between documented and actual agents
- ‚ùå No validation between what's documented and what's created
- ‚ùå Systemic issue affecting all template creation

### Root Cause
Identified in TASK-018 investigation:
- Phase 5 AI predicts what agents "should" exist based on architecture analysis
- Phase 7 AI decides what agents to actually create based on capability gaps
- These two AI decisions are made independently without coordination
- No validation ensures they match

## Proposed Solution

**Reorder phases so CLAUDE.md is generated AFTER agents are created**, allowing it to document only what actually exists.

### New Corrected Order
```
Phase 1: Q&A Session
Phase 2: AI Analysis
Phase 3: Manifest Generation
Phase 4: Settings Generation
Phase 5: Template File Generation  ‚Üê Moved earlier (was Phase 6)
Phase 6: Agent Recommendation      ‚Üê Moved earlier (was Phase 7)
Phase 7: CLAUDE.md Generation      ‚Üê Moved later, NOW anchored to reality
Phase 8: Package Assembly
```

### Benefits
‚úÖ **Eliminates hallucination** - CLAUDE.md reads `agents/` directory to see what exists
‚úÖ **Perfect accuracy** - Agent documentation always matches reality
‚úÖ **Simpler than validation** - No need for Phase 7.5 validation logic
‚úÖ **Better information flow** - Each phase builds on previous phase outputs
‚úÖ **Self-documenting** - Agents themselves are source of truth

## Acceptance Criteria

### AC1: Phase Ordering Updated
- [ ] `/template-create` command spec updated with new phase order
- [ ] Phase numbers renumbered correctly (5‚Üí7, 6‚Üí5, 7‚Üí6)
- [ ] Workflow diagram updated in command documentation
- [ ] All phase descriptions reflect correct dependencies

### AC2: Orchestrator Code Updated
- [ ] `installer/global/commands/lib/template_create_orchestrator.py` phase execution reordered
- [ ] Phase 5 (Template File Generation) executes before Phase 6 (Agent Recommendation)
- [ ] Phase 6 (Agent Recommendation) executes before Phase 7 (CLAUDE.md Generation)
- [ ] Progress messages display correct phase numbers
- [ ] Error handling updated for new phase order

### AC3: CLAUDE.md Generator Enhanced
- [ ] Phase 7 CLAUDE.md generator reads actual agents from `agents/` directory
- [ ] Agent documentation generated by reading agent files (not predicting)
- [ ] Agent capabilities extracted from agent file content (Purpose, Capabilities sections)
- [ ] Agent usage examples based on actual agent names
- [ ] No hardcoded agent names in CLAUDE.md generation logic

### AC4: Template File Dependencies Validated
- [ ] Template File Generation (new Phase 5) has no dependencies on agents
- [ ] Agent Recommendation (new Phase 6) can run after templates created
- [ ] CLAUDE.md Generation (new Phase 7) successfully reads from agents directory
- [ ] No circular dependencies introduced

### AC5: Testing and Validation
- [ ] Unit tests updated for new phase order
- [ ] Integration test: Full `/template-create` run with new order
- [ ] Validation: CLAUDE.md references only agents that exist in `agents/`
- [ ] Regression test: Re-generate `ardalis-clean-architecture` template
- [ ] Verification: New template has 100% agent documentation accuracy

### AC6: Documentation Updated
- [ ] `installer/global/commands/template-create.md` updated (lines 45-100)
- [ ] Output structure documentation reflects new phase order (lines 102-122)
- [ ] Component generation section updated (lines 267-404)
- [ ] Examples updated with correct phase numbers
- [ ] "Implementation Details" section reflects new orchestrator logic

### AC7: Immediate Fix Applied
- [ ] `ardalis-clean-architecture` template CLAUDE.md fixed (remove lines 811-823)
- [ ] Template regenerated with new phase order
- [ ] Template tested with `taskwright init ardalis-clean-architecture`
- [ ] Zero agent documentation mismatches

## Implementation Plan

### Step 1: Update Command Documentation (30 min)
**File**: `installer/global/commands/template-create.md`

Update sections:
- Lines 45-100: Complete Workflow (renumber phases)
- Lines 267-404: Component Generation (update phase numbers and dependencies)
- Lines 348-359: CLAUDE.md Generation (document new approach)
- Lines 390-404: Agent Recommendation (note it now runs before CLAUDE.md)

### Step 2: Update Orchestrator Code (2-3 hours)
**File**: `installer/global/commands/lib/template_create_orchestrator.py`

Changes needed:
```python
def execute_template_creation(context: CreationContext) -> TemplatePackage:
    """Execute all phases in correct order."""

    # Phases 1-4 unchanged
    phase_1_qa_session(context)
    phase_2_ai_analysis(context)
    phase_3_manifest_generation(context)
    phase_4_settings_generation(context)

    # PHASE 5: Template File Generation (was Phase 6)
    template_files = phase_5_template_generation(context)

    # PHASE 6: Agent Recommendation (was Phase 7)
    agents = phase_6_agent_recommendation(context)

    # PHASE 7: CLAUDE.md Generation (was Phase 5)
    # NOW can read from agents created in Phase 6
    claude_md = phase_7_claude_md_generation(
        context,
        agents_dir=context.output_dir / "agents"
    )

    # Phase 8 unchanged
    phase_8_package_assembly(context, template_files, agents, claude_md)
```

### Step 3: Enhance CLAUDE.md Generator (1-2 hours)
**File**: `installer/global/lib/template_generator/claude_md_generator.py`

Add new function:
```python
def generate_agent_usage_guidelines(agents_dir: Path) -> str:
    """
    Generate agent documentation based on ACTUAL agent files.
    Reads agents directory and extracts information from agent files.
    """
    agent_files = sorted(agents_dir.glob("*.md"))

    if not agent_files:
        return "### No Custom Agents\nThis template uses global agents only."

    guidelines = "## Agent Usage Guidelines\n\n"
    guidelines += "### When to Use Specialized Agents\n\n"

    for i, agent_file in enumerate(agent_files, 1):
        agent_name = agent_file.stem
        agent_content = agent_file.read_text()

        # Extract purpose from "## Purpose" section
        purpose = extract_section(agent_content, "Purpose")

        # Extract capabilities from "## Expertise" or "## Capabilities"
        capabilities = extract_list_items(agent_content, "Expertise|Capabilities")

        guidelines += f"#### {i}. **{agent_name}**\n"
        if purpose:
            guidelines += f"{purpose}\n\n"
        guidelines += "Use for:\n"
        for cap in capabilities[:5]:  # Top 5 capabilities
            guidelines += f"- {cap}\n"
        guidelines += f"\nExample:\n```\n"
        guidelines += f'/task-create "Your task description"\n'
        guidelines += f'/task-work TASK-XXX\n'
        guidelines += f'# Agent: {agent_name} handles implementation\n'
        guidelines += "```\n\n"

    return guidelines
```

### Step 4: Update Tests (1 hour)
**Files**:
- `tests/unit/test_template_create_phases.py`
- `tests/integration/test_template_create_orchestrator.py`

Updates:
- Phase execution order tests
- Phase number assertions
- CLAUDE.md content validation (agents match directory)
- Integration test for full workflow

### Step 5: Regenerate ardalis-clean-architecture (30 min)
```bash
# Fix current template immediately
# Remove hallucinated agent from CLAUDE.md

# Then regenerate with new workflow
/template-create --path /path/to/CleanArchitecture-ardalis

# Verify
taskwright init ardalis-clean-architecture
grep -c "specialist" .claude/CLAUDE.md  # Should equal agent count
ls .claude/agents/*.md | wc -l          # Should match CLAUDE.md references
```

## Files to Modify

```
installer/global/commands/
‚îú‚îÄ‚îÄ template-create.md                           ‚Üê Update documentation
‚îî‚îÄ‚îÄ lib/
    ‚îî‚îÄ‚îÄ template_create_orchestrator.py         ‚Üê Reorder phase execution

installer/global/lib/template_generator/
‚îî‚îÄ‚îÄ claude_md_generator.py                      ‚Üê Add agent directory reading

installer/global/templates/ardalis-clean-architecture/
‚îî‚îÄ‚îÄ CLAUDE.md                                   ‚Üê Immediate fix (remove lines 811-823)

tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îî‚îÄ‚îÄ test_template_create_phases.py         ‚Üê Update phase order tests
‚îî‚îÄ‚îÄ integration/
    ‚îî‚îÄ‚îÄ test_template_create_orchestrator.py   ‚Üê Update workflow tests
```

## Testing Plan

### Unit Tests
```python
def test_phase_execution_order():
    """Verify phases execute in correct order."""
    orchestrator = TemplateCreateOrchestrator()
    execution_log = []

    # Mock each phase to log execution
    with patch_phases(execution_log):
        orchestrator.execute()

    assert execution_log == [
        "phase_1_qa",
        "phase_2_analysis",
        "phase_3_manifest",
        "phase_4_settings",
        "phase_5_templates",    # Was phase 6
        "phase_6_agents",       # Was phase 7
        "phase_7_claude_md",    # Was phase 5
        "phase_8_assembly"
    ]

def test_claude_md_reads_actual_agents():
    """Verify CLAUDE.md documents only agents that exist."""
    agents_dir = Path("temp/agents")
    agents_dir.mkdir(parents=True)

    # Create test agents
    (agents_dir / "test-agent-1.md").write_text("## Purpose\nTest agent")
    (agents_dir / "test-agent-2.md").write_text("## Purpose\nAnother test")

    # Generate CLAUDE.md
    claude_md = generate_claude_md(agents_dir=agents_dir)

    # Verify it references both agents
    assert "test-agent-1" in claude_md
    assert "test-agent-2" in claude_md

    # Verify it doesn't reference non-existent agents
    assert "non-existent-agent" not in claude_md
```

### Integration Test
```bash
# Full workflow test
/template-create --path /path/to/test/codebase --output /tmp/test-template

# Validation
agents_count=$(ls /tmp/test-template/agents/*.md 2>/dev/null | wc -l)
claude_refs=$(grep -c "^#### [0-9]" /tmp/test-template/CLAUDE.md)

if [ "$agents_count" -eq "$claude_refs" ]; then
    echo "‚úÖ PASS: Agent count matches CLAUDE.md references"
else
    echo "‚ùå FAIL: Mismatch - $agents_count agents, $claude_refs references"
    exit 1
fi
```

### Regression Test
```bash
# Regenerate all templates with new workflow
for template in react python maui-appshell dotnet-fastendpoints; do
    /template-create --from-existing $template --validate
done

# Verify no agent documentation mismatches
./scripts/validate-all-templates.sh
```

## Risk Assessment

### Low Risk
- Phase 5 and 6 swap has no interdependencies
- Template file generation doesn't need agent information
- Agent recommendation doesn't need template files
- CLAUDE.md is last component generated (no downstream dependencies)

### Medium Risk
- Orchestrator code changes could introduce bugs
- Test updates required to reflect new order
- Need to ensure no hidden dependencies between phases

### Mitigation
- Comprehensive unit tests for phase order
- Integration tests for full workflow
- Dry-run mode testing before actual template generation
- Rollback plan: Git revert if issues found

## Success Metrics

‚úÖ **Zero hallucinated agents** in CLAUDE.md across all templates
‚úÖ **100% accuracy** - documented agents match created agents
‚úÖ **All tests pass** with new phase order
‚úÖ **ardalis-clean-architecture** template regenerated successfully
‚úÖ **No regression** in other template functionality

## Related Issues

- **TASK-018**: Investigation of agent documentation mismatch (parent issue)
- **Future**: Audit all existing templates for similar issues (follow-up task)
- **Future**: Add validation script to CI/CD (prevention task)

## Context & Background

### Discovery
During Section 3 analysis of the `ardalis-clean-architecture` template (TASK-018), we discovered that CLAUDE.md documented a `clean-architecture-specialist` agent that was never created. Investigation revealed this is a **systemic design flaw** in the `/template-create` workflow, not an isolated incident.

### Impact
- **User-facing**: Developers following CLAUDE.md will attempt to invoke non-existent agents
- **Trust damage**: 98% confidence score, yet critical documentation error
- **Systemic**: Affects all future template creation
- **Quality**: Undermines the value proposition of AI-generated templates

### Solution Rationale
Reordering phases is the **cleanest architectural fix** because:
1. Makes it **impossible** for CLAUDE.md to document non-existent agents
2. Simpler than adding validation logic
3. Better information flow (each phase builds on previous)
4. Agents become single source of truth for documentation

## Implementation Notes

### Phase Dependencies
```
Phase 1 (Q&A)           ‚Üí Phase 2 (Analysis)
Phase 2 (Analysis)      ‚Üí Phase 3, 4, 5, 6
Phase 3 (Manifest)      ‚Üí Phase 8 (Assembly)
Phase 4 (Settings)      ‚Üí Phase 8 (Assembly)
Phase 5 (Templates)     ‚Üí Phase 8 (Assembly)
Phase 6 (Agents)        ‚Üí Phase 7 (CLAUDE.md)
Phase 7 (CLAUDE.md)     ‚Üí Phase 8 (Assembly)
```

### Critical Path
The **only critical dependency** is:
```
Phase 6 (Agent Creation) MUST complete BEFORE Phase 7 (CLAUDE.md Generation)
```

All other phases can remain in current order or be further optimized if needed.

## Estimated Effort

- **Total**: 4-6 hours
- **Documentation**: 30 minutes
- **Code changes**: 2-3 hours
- **Testing**: 1-2 hours
- **Validation**: 30 minutes
- **Regeneration**: 30 minutes

## Next Steps

1. ‚úÖ Task created (TASK-019A)
2. ‚è∏Ô∏è Wait for user to invoke `/task-work TASK-019A`
3. üéØ Implement phase reordering with all acceptance criteria
4. ‚úÖ Test and validate
5. üì¶ Regenerate ardalis-clean-architecture template
6. üîç Follow-up: Audit other templates (separate task)

---

**Created**: 2025-01-07
**Related to**: TASK-018 (Root cause investigation)
**Fixes**: Systemic agent documentation hallucination issue
**Impact**: High (prevents future template quality issues)
