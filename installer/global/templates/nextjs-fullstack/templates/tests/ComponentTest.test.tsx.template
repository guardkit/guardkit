import { describe, it, expect, vi } from 'vitest'
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import { {{EntityName}}Form } from './{{EntityName}}Form'
import * as {{entityName}}Actions from '@/app/actions/{{entityNamePlural}}'

// Mock the server actions
vi.mock('@/app/actions/{{entityNamePlural}}', () => ({
  create{{EntityName}}: vi.fn(),
}))

describe('{{EntityName}}Form', () => {
  it('renders form fields correctly', () => {
    render(<{{EntityName}}Form />)

    expect(screen.getByLabelText(/name/i)).toBeInTheDocument()
    expect(screen.getByRole('button', { name: /create {{entityName}}/i })).toBeInTheDocument()
  })

  it('submits form with valid data', async () => {
    const mockCreate{{EntityName}} = vi.mocked({{entityName}}Actions.create{{EntityName}})
    mockCreate{{EntityName}}.mockResolvedValue({
      success: true,
      data: { id: '1', name: 'Test {{EntityName}}', createdAt: new Date(), updatedAt: new Date() }
    })

    const onSuccess = vi.fn()
    render(<{{EntityName}}Form onSuccess={onSuccess} />)

    fireEvent.change(screen.getByLabelText(/name/i), {
      target: { value: 'Test {{EntityName}}' },
    })

    fireEvent.click(screen.getByRole('button', { name: /create {{entityName}}/i }))

    await waitFor(() => {
      expect(mockCreate{{EntityName}}).toHaveBeenCalled()
      expect(onSuccess).toHaveBeenCalled()
    })
  })

  it('displays error on failed submission', async () => {
    const mockCreate{{EntityName}} = vi.mocked({{entityName}}Actions.create{{EntityName}})
    mockCreate{{EntityName}}.mockResolvedValue({ success: false, error: 'Validation failed' })

    render(<{{EntityName}}Form />)

    fireEvent.change(screen.getByLabelText(/name/i), {
      target: { value: 'Test' },
    })

    fireEvent.click(screen.getByRole('button', { name: /create {{entityName}}/i }))

    await waitFor(() => {
      expect(screen.getByText(/validation failed/i)).toBeInTheDocument()
    })
  })
})
