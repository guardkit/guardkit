# Data Contracts: EPIC-001 Template Creation System

**Date**: 2025-11-01
**Status**: ✅ **DOCUMENTED**
**Version**: 1.0.0

---

## Overview

This directory contains comprehensive documentation for all data contracts used in the EPIC-001 Template Creation Automation system. Data contracts define the structure, validation rules, and versioning strategy for data exchanged between tasks.

**Purpose**: Ensure type safety, data integrity, and clear integration points across the system.

---

## Contract Categories

### 1. Q&A Session Contracts
**File**: [qa-contracts.md](qa-contracts.md)

| Contract | Status | Used By | Schema Version |
|----------|--------|---------|----------------|
| `BrownfieldAnswers` | ✅ DEFINED | TASK-001 → TASK-002 | 1.0.0 |
| `GreenfieldAnswers` | ✅ DEFINED | TASK-001B → TASK-011 | 1.0.0 |

**Purpose**: Capture user responses from Q&A sessions for brownfield and greenfield template creation.

---

### 2. Analysis Contracts
**File**: [analysis-contracts.md](analysis-contracts.md)

| Contract | Status | Used By | Schema Version |
|----------|--------|---------|----------------|
| `CodebaseAnalysis` | ✅ DEFINED | TASK-002 → TASK-003, 005-009 | 1.0.0 |
| `LayerInfo` | ✅ DEFINED | CodebaseAnalysis sub-structure | 1.0.0 |
| `ExampleFile` | ✅ DEFINED | CodebaseAnalysis sub-structure | 1.0.0 |
| `TechnologyInfo` | ✅ DEFINED | CodebaseAnalysis sub-structure | 1.0.0 |
| `ArchitectureInfo` | ✅ DEFINED | CodebaseAnalysis sub-structure | 1.0.0 |
| `QualityInfo` | ✅ DEFINED | CodebaseAnalysis sub-structure | 1.0.0 |

**Purpose**: Represent AI-powered codebase analysis results (brownfield) or inferred analysis (greenfield).

---

### 3. Agent Contracts
**File**: [agent-contracts.md](agent-contracts.md)

| Contract | Status | Used By | Schema Version |
|----------|--------|---------|----------------|
| `AgentInventory` | ✅ DEFINED | TASK-003 → TASK-009 | 1.0.0 |
| `AgentInfo` | ✅ DEFINED | AgentInventory sub-structure | 1.0.0 |
| `GeneratedAgent` | ✅ DEFINED | TASK-004A → TASK-009 | 1.0.0 |
| `DiscoveredAgent` | ✅ DEFINED | TASK-004B → TASK-009 | 1.0.0 |
| `AgentRecommendation` | ✅ DEFINED | TASK-009 → TASK-010, 011 | 1.0.0 |
| `AgentSuggestion` | ✅ DEFINED | AgentRecommendation sub-structure | 1.0.0 |

**Purpose**: Define agent structures for discovery, generation, and recommendation workflows.

---

### 4. Template Contracts
**File**: [template-contracts.md](template-contracts.md)

| Contract | Status | Used By | Schema Version |
|----------|--------|---------|----------------|
| `TemplateManifest` | ✅ DEFINED | TASK-005 → TASK-010, 011 | 1.0.0 |
| `TemplateSettings` | ✅ DEFINED | TASK-006 → TASK-010, 011 | 1.0.0 |
| `TemplateClaude` | ✅ DEFINED | TASK-007 → TASK-010, 011 | 1.0.0 |
| `CodeTemplate` | ✅ DEFINED | TASK-008 → TASK-010, 011 | 1.0.0 |
| `Template` | ✅ DEFINED | Complete template structure | 1.0.0 |

**Purpose**: Define template file structures generated by the system.

---

### 5. Orchestration Contracts
**File**: [orchestration-contracts.md](orchestration-contracts.md)

| Contract | Status | Used By | Schema Version |
|----------|--------|---------|----------------|
| `TemplateCreateResult` | ✅ DEFINED | TASK-010 output | 1.0.0 |
| `TemplateInitResult` | ✅ DEFINED | TASK-011 output | 1.0.0 |
| `ValidationResult` | ✅ DEFINED | All validators | 1.0.0 |
| `AnalysisProvider` | ✅ DEFINED | Brownfield + Greenfield abstraction | 1.0.0 |

**Purpose**: Define command orchestration results and abstractions.

---

## Schema Versioning Strategy

All data contracts use **Semantic Versioning** (MAJOR.MINOR.PATCH):

- **MAJOR**: Breaking changes (incompatible data structure changes)
- **MINOR**: Backward-compatible additions (new optional fields)
- **PATCH**: Bug fixes, documentation updates

### Version Compatibility Rules

```python
# All dataclasses include schema_version field
@dataclass
class CodebaseAnalysis:
    schema_version: str = "1.0.0"  # Required field
    # ... other fields
```

**Compatibility Checker**:
```python
class SchemaVersionChecker:
    """Verify data contract compatibility"""

    CURRENT_VERSIONS = {
        "CodebaseAnalysis": "1.0.0",
        "TemplateManifest": "1.0.0",
        # ... all contracts
    }

    def is_compatible(self, schema_type: str, version: str) -> bool:
        """Check if version is compatible with current"""
        current = self.CURRENT_VERSIONS.get(schema_type)
        if not current:
            return False

        current_major = int(current.split(".")[0])
        version_major = int(version.split(".")[0])

        # Breaking change if major version differs
        return current_major == version_major
```

---

## Validation Strategy

All contracts support validation through a common `Validator` interface:

```python
class Validator(ABC):
    """Base validator for data contracts"""

    @abstractmethod
    def validate(self, data: Any) -> ValidationResult:
        """Validate data contract, return result with errors"""
        pass
```

**Validation Result Contract**:
```python
@dataclass
class ValidationResult:
    """Result of data contract validation"""
    is_valid: bool
    errors: List[str]
    warnings: List[str]
    metadata: Dict[str, Any]
```

See [orchestration-contracts.md](orchestration-contracts.md) for details.

---

## Contract Usage Guidelines

### 1. Always Include Schema Version

```python
# ✅ CORRECT
@dataclass
class CodebaseAnalysis:
    schema_version: str = "1.0.0"
    language: str
    # ... fields

# ❌ INCORRECT (missing schema_version)
@dataclass
class CodebaseAnalysis:
    language: str
    # ... fields
```

### 2. Validate at Boundaries

```python
# Validate when crossing task boundaries
def task_002_output(analysis: CodebaseAnalysis) -> CodebaseAnalysis:
    validator = CodebaseAnalysisValidator()
    result = validator.validate(analysis)

    if not result.is_valid:
        raise ValidationError(result.errors)

    return analysis
```

### 3. Use Type Hints

```python
# ✅ CORRECT (explicit types)
@dataclass
class TemplateManifest:
    name: str
    version: str
    language: str
    frameworks: List[str]

# ❌ INCORRECT (no types)
@dataclass
class TemplateManifest:
    name: ...
    version: ...
```

### 4. Document Optional Fields

```python
@dataclass
class GreenfieldAnswers:
    # Required fields
    template_name: str
    language: str

    # Optional fields (document clearly)
    company_standards: Optional[CompanyStandards] = None
    custom_patterns: Optional[List[str]] = None
```

### 5. Use Nested Dataclasses for Complex Structures

```python
# ✅ CORRECT (nested dataclasses)
@dataclass
class CodebaseAnalysis:
    technology: TechnologyInfo  # Nested
    architecture: ArchitectureInfo  # Nested

@dataclass
class TechnologyInfo:
    language: str
    frameworks: List[str]

# ❌ INCORRECT (flat dict)
@dataclass
class CodebaseAnalysis:
    technology: dict  # Untyped, loses structure
```

---

## Contract Dependencies

```
┌─────────────────────────────────────────────────────────────┐
│ Q&A Contracts                                                │
│ - BrownfieldAnswers                                          │
│ - GreenfieldAnswers                                          │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Analysis Contracts                                           │
│ - CodebaseAnalysis (from AI or inferred)                    │
│   ├─ TechnologyInfo                                          │
│   ├─ ArchitectureInfo                                        │
│   ├─ QualityInfo                                             │
│   ├─ LayerInfo[]                                             │
│   └─ ExampleFile[]                                           │
└─────────────────────────────────────────────────────────────┘
                          ↓
         ┌────────────────┴────────────────┐
         ↓                                  ↓
┌──────────────────────┐        ┌──────────────────────┐
│ Agent Contracts      │        │ Template Contracts   │
│ - AgentInventory     │        │ - TemplateManifest   │
│ - GeneratedAgent     │        │ - TemplateSettings   │
│ - AgentRecommendation│        │ - TemplateClaude     │
└──────────────────────┘        │ - CodeTemplate       │
                                └──────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Orchestration Contracts                                      │
│ - TemplateCreateResult                                       │
│ - TemplateInitResult                                         │
└─────────────────────────────────────────────────────────────┘
```

---

## Data Flow Summary

### Brownfield Flow (`/template-create`)

```
BrownfieldAnswers (TASK-001)
        ↓
CodebaseAnalysis (TASK-002)
        ↓
    ┌───┴────┐
    ↓        ↓
AgentInventory  TemplateManifest
AgentRecommendation  TemplateSettings
(TASK-003, 009)  TemplateClaude
                 CodeTemplate[]
                 (TASK-005-008)
        ↓
TemplateCreateResult (TASK-010)
```

### Greenfield Flow (`/template-init`)

```
GreenfieldAnswers (TASK-001B)
        ↓
CodebaseAnalysis (inferred via AnalysisProvider)
        ↓
    ┌───┴────┐
    ↓        ↓
AgentRecommendation  TemplateManifest
(TASK-009)           TemplateSettings
                     TemplateClaude
                     CodeTemplate[]
                     (TASK-005-008)
        ↓
TemplateInitResult (TASK-011)
```

---

## Contract Files

| File | Contracts | Lines | Status |
|------|-----------|-------|--------|
| [qa-contracts.md](qa-contracts.md) | 2 | ~400 | ✅ Complete |
| [analysis-contracts.md](analysis-contracts.md) | 6 | ~600 | ✅ Complete |
| [agent-contracts.md](agent-contracts.md) | 6 | ~500 | ✅ Complete |
| [template-contracts.md](template-contracts.md) | 5 | ~600 | ✅ Complete |
| [orchestration-contracts.md](orchestration-contracts.md) | 4 | ~400 | ✅ Complete |

**Total**: 23 contracts, ~2500 lines of documentation

---

## Quick Reference

### Creating a New Contract

1. **Define the dataclass** with schema version:
   ```python
   @dataclass
   class MyContract:
       schema_version: str = "1.0.0"
       # ... fields
   ```

2. **Create validator**:
   ```python
   class MyContractValidator(Validator):
       def validate(self, data: MyContract) -> ValidationResult:
           # validation logic
   ```

3. **Document in appropriate file**:
   - Add to category markdown file
   - Update this README
   - Add to schema version checker

4. **Add unit tests**:
   ```python
   def test_my_contract_creation():
       contract = MyContract(field1="value")
       assert contract.schema_version == "1.0.0"

   def test_my_contract_validation():
       validator = MyContractValidator()
       result = validator.validate(contract)
       assert result.is_valid
   ```

### Evolving a Contract

**Minor Version (backward-compatible)**:
```python
# Before (1.0.0)
@dataclass
class CodebaseAnalysis:
    schema_version: str = "1.0.0"
    language: str
    frameworks: List[str]

# After (1.1.0) - added optional field
@dataclass
class CodebaseAnalysis:
    schema_version: str = "1.1.0"
    language: str
    frameworks: List[str]
    license: Optional[str] = None  # NEW, optional
```

**Major Version (breaking change)**:
```python
# Before (1.0.0)
@dataclass
class CodebaseAnalysis:
    schema_version: str = "1.0.0"
    frameworks: List[str]  # Simple list

# After (2.0.0) - changed data structure
@dataclass
class CodebaseAnalysis:
    schema_version: str = "2.0.0"
    frameworks: List[FrameworkInfo]  # BREAKING: now complex objects

# Provide migration function
def migrate_1_to_2(old: dict) -> dict:
    """Migrate CodebaseAnalysis from v1.0 to v2.0"""
    old["frameworks"] = [
        {"name": fw, "version": "unknown"}
        for fw in old["frameworks"]
    ]
    old["schema_version"] = "2.0.0"
    return old
```

---

## Testing Strategy

All data contracts must have:

1. **Creation tests**: Verify object creation
2. **Validation tests**: Verify validation logic
3. **Serialization tests**: Verify JSON round-trip
4. **Schema version tests**: Verify compatibility checking

Example test suite:
```python
# tests/test_data_contracts.py

def test_codebase_analysis_creation():
    """Test CodebaseAnalysis creation"""
    analysis = CodebaseAnalysis(
        schema_version="1.0.0",
        language="Python",
        frameworks=["FastAPI"],
        # ... all fields
    )
    assert analysis.language == "Python"

def test_codebase_analysis_validation():
    """Test CodebaseAnalysis validation"""
    validator = CodebaseAnalysisValidator()

    # Valid
    valid_analysis = create_valid_analysis()
    result = validator.validate(valid_analysis)
    assert result.is_valid

    # Invalid (missing required field)
    invalid_analysis = CodebaseAnalysis(language=None)
    result = validator.validate(invalid_analysis)
    assert not result.is_valid
    assert "language is required" in result.errors

def test_codebase_analysis_serialization():
    """Test JSON serialization/deserialization"""
    analysis = create_valid_analysis()

    # Serialize
    json_str = json.dumps(asdict(analysis))

    # Deserialize
    data = json.loads(json_str)
    restored = CodebaseAnalysis(**data)

    assert restored == analysis

def test_schema_version_compatibility():
    """Test schema version checking"""
    checker = SchemaVersionChecker()

    # Compatible (same major version)
    assert checker.is_compatible("CodebaseAnalysis", "1.0.0")
    assert checker.is_compatible("CodebaseAnalysis", "1.1.0")

    # Incompatible (different major version)
    assert not checker.is_compatible("CodebaseAnalysis", "2.0.0")
```

---

## References

- **System Integration Review**: [EPIC-001-SYSTEM-INTEGRATION-REVIEW.md](../../tasks/backlog/EPIC-001-SYSTEM-INTEGRATION-REVIEW.md)
- **Agent Strategy**: [AGENT-STRATEGY-high-level-design.md](../../tasks/backlog/AGENT-STRATEGY-high-level-design.md)
- **Template Lifecycle**: [TEMPLATE-LIFECYCLE-complete-flow.md](../../tasks/backlog/TEMPLATE-LIFECYCLE-complete-flow.md)

---

**Created**: 2025-11-01
**Status**: ✅ **COMPLETE**
**Next Steps**: Read individual contract files for detailed specifications
