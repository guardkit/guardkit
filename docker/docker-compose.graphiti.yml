# Docker Compose configuration for Graphiti knowledge graph services
#
# Services:
#   - neo4j: Graph database backend
#   - graphiti: Temporal knowledge graph API server
#
# Usage:
#   # Start services
#   docker compose -f docker/docker-compose.graphiti.yml up -d
#
#   # View logs
#   docker compose -f docker/docker-compose.graphiti.yml logs -f
#
#   # Stop services
#   docker compose -f docker/docker-compose.graphiti.yml down
#
#   # Stop and remove volumes (clean slate)
#   docker compose -f docker/docker-compose.graphiti.yml down -v
#
# Requirements:
#   - Docker and Docker Compose installed
#   - OPENAI_API_KEY environment variable set (for embeddings)
#
# Access:
#   - Graphiti API: http://localhost:8000
#   - Graphiti Docs: http://localhost:8000/docs
#   - Neo4j Browser: http://localhost:7474
#
# Note: The zepai/graphiti:latest image may be outdated. If you encounter issues,
# consider using the Python library directly instead of the Docker image.
# See: https://github.com/getzep/graphiti/issues/1030

services:
  neo4j:
    image: neo4j:5.26.0
    container_name: guardkit-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/password123
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "password123", "RETURN 1"]
      interval: 10s
      timeout: 10s
      retries: 10
    restart: unless-stopped
    networks:
      - guardkit-knowledge

  graphiti:
    image: zepai/graphiti:latest
    container_name: guardkit-graphiti
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password123
      - MODEL_NAME=gpt-4o-mini
      - EMBEDDING_MODEL=text-embedding-3-small
    depends_on:
      neo4j:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - guardkit-knowledge

volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local

networks:
  guardkit-knowledge:
    driver: bridge
